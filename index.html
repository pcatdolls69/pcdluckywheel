<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¹¸è¿è½¬ç›˜ / Lucky Wheel</title>
<style>
Â Â body{
Â Â Â Â margin:0; color:#333;
Â Â Â Â font-family:'Noto Sans SC', Arial, sans-serif;
Â Â Â Â background: linear-gradient(180deg, #fde6ff 0%, #e4f2ff 100%);
Â Â Â Â display:flex; flex-direction:column; align-items:center; min-height:100vh;
Â Â }
Â Â h2{margin:20px 0 10px}
Â Â #wheel-container{position:relative; width:420px; height:420px; margin-top:10px}
Â Â canvas{
Â Â Â Â width:100%; height:100%; border-radius:50%;
Â Â Â Â box-shadow: 0 0 30px rgba(255,255,255,.85), 0 0 60px rgba(255,200,255,.6);
Â Â Â Â background:#fff;
Â Â }
Â Â #centerPointer{position:absolute; inset:0; pointer-events:none}
Â Â #centerPointer polygon{fill:#fff}

Â Â /* ä¸»æŒ‰é’®ï¼šç²‰ç´«æ¸å˜ï¼Œåœ†è§’ */
Â Â #spinBtn, .cta button {
  background: #ffe6f9;          /* æ·¡ç²‰åº• */
  border: 2px solid #f3c8f0;    /* æ·¡ç´«é‚Šæ¡† */
  border-radius: 16px;          /* åœ“æ½¤å¤–å‹ */
  color: #5a0060;
  font-weight: 700;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}

  #spinBtn, .cta {
    position: relative;
    top: -30px;
  }
  
.cta {
  display: flex;
  gap: 10px;
  margin-top: 14px;
  justify-content: center;
}

#footer {
  margin: 10px 0 0;   /* è²¼è¿‘è½‰ç›¤åº•éƒ¨ */
  text-align: center;
  font-size: 13px;
  color:#fff;
}

Â Â /* åº•éƒ¨æ³¨æ„ */
Â Â #footer{margin:10px 0 0px; text-align:center; font-size:13px}
Â Â #footer a{color:#fff; font-weight:700; text-decoration:none}

Â Â /* å€’è®¡æ—¶æ ·å¼ */
Â Â #cooldown{ margin-top:8px; font-size:13px; color:#f6b6d5; }
</style>
</head>
<body>

<h2>å¹¸è¿è½¬ç›˜ / Lucky Wheel</h2>

<div id="wheel-container">
Â Â <canvas id="wheel" width="420" height="420"></canvas>
Â Â <!-- ä¸­å¿ƒæ·±ç´«ä¸‰è§’æŒ‡é’ˆï¼ˆä»ä¸­å¿ƒæŒ‡å‘ 12 ç‚¹ï¼Œå°–ç«¯ç•¥è¶…å‡ºåœ†ç›˜ï¼‰ -->
Â Â <svg id="centerPointer" viewBox="0 0 420 440" aria-hidden="true">
Â Â Â Â <polygon points="208,415 212,415 210,388" fill="#2e0854" ></polygon>
Â Â </svg>
</div>

<button id="spinBtn">å¼€å§‹æŠ½å¥– / Start</button>
<div id="status">å‰©ä½™æ¬¡æ•° / Chances: <span id="chances">0</span></div>
<div id="cooldown" hidden></div>

<div class="cta">
Â Â <button id="subBtn">ğŸ”— è®¢é˜… / Subscribeï¼ˆ+1ï¼‰</button>
Â Â <button id="shareBtn">ğŸ”— åˆ†äº« / Shareï¼ˆ+1ï¼‰</button>
</div>

<div id="footer">
Â Â âš ï¸ æ‰€æœ‰å¥–é¡¹ä¸èƒ½é‡å ä½¿ç”¨ / All prizes cannot be combined<br>
Â Â <a href="https://t.me/pcatdolls" target="_blank">pcatdolls é¢‘é“ / Channel</a>
</div>

<script>
/* ===== Telegram Mini App åˆå§‹åŒ– ===== */
const isTG = !!(window.Telegram && Telegram.WebApp);
if (isTG) Telegram.WebApp.ready();

/* ===== è½®ç›˜æ•°æ® ===== */
const prizes = [
Â Â "45â° or 60â° / 10 OFF",
Â Â "45â° or 60â° / 20 OFF",
Â Â "One more spin chance",
Â Â "45â° or 60â° / 10 OFF",
Â Â "Sorry ğŸ˜¢",
Â Â "45â° or 60â° / 20 OFF",
Â Â "Sorry ğŸ˜¢",
Â Â "45â° or 60â° / 40 OFF",
Â Â "Sorry ğŸ˜¢"
];
const colors = ["#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8"];

/* ====== ğŸ”§ æ¯ 3 å¤©ä¸€æ¬¡å…è´¹è½¬ç›˜ + å¥–åŠ±æ¬¡æ•°ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ ====== */
const THREE_DAYS = 3 * 24 * 60 * 60 * 1000;
const LS_LAST = "pcdLastSpinAt";
const LS_BONUS = "pcdBonusSpins";

let lastSpinAt = parseInt(localStorage.getItem(LS_LAST) || "0", 10);
let bonusSpins = parseInt(localStorage.getItem(LS_BONUS) || "0", 10);

const chancesEl = document.getElementById('chances');
const spinBtn = document.getElementById('spinBtn');
const cooldownEl = document.getElementById('cooldown');

function baseSpinAvailable() {
Â Â return Date.now() - lastSpinAt >= THREE_DAYS;
}
function totalChances() {
Â Â return (baseSpinAvailable() ? 1 : 0) + bonusSpins;
}
function saveState() {
Â Â localStorage.setItem(LS_LAST, String(lastSpinAt));
Â Â localStorage.setItem(LS_BONUS, String(bonusSpins));
}
function updateUI() {
Â Â chancesEl.textContent = String(totalChances());
Â Â spinBtn.disabled = totalChances() <= 0;

Â Â // å€’è®¡æ—¶ï¼ˆä»…å½“å…è´¹æ¬¡æ•°ä¸å¯ç”¨æ—¶æ˜¾ç¤ºï¼‰
Â Â if (!baseSpinAvailable()) {
Â Â Â Â cooldownEl.hidden = false;
Â Â Â Â const remainMs = THREE_DAYS - (Date.now() - lastSpinAt);
Â Â Â Â cooldownEl.textContent = "ä¸‹æ¬¡å…è´¹è½¬ç›˜å€’è®¡æ—¶ / Next free spin in: " + fmtDuration(remainMs);
Â Â } else {
Â Â Â Â cooldownEl.hidden = true;
Â Â }
}
function fmtDuration(ms) {
Â Â const s = Math.max(0, Math.floor(ms/1000));
Â Â const d = Math.floor(s / 86400);
Â Â const h = Math.floor((s % 86400) / 3600);
Â Â const m = Math.floor((s % 3600) / 60);
Â Â const sec = s % 60;
Â Â const pad = n => String(n).padStart(2,'0');
Â Â return (d>0? d+"d ":"") + pad(h)+":"+pad(m)+":"+pad(sec);
}
// æ¯ç§’åˆ·æ–°ä¸€æ¬¡å€’è®¡æ—¶
setInterval(updateUI, 1000);
updateUI();

/* ===== ç”»è½®ç›˜ ===== */
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');

function drawWheel(angleOffset = 0) {
Â Â const cx = 210, cy = 210, r = 200;
Â Â const n = prizes.length;
Â Â const arc = 2*Math.PI / n;
Â Â ctx.clearRect(0,0,420,420);
Â Â for (let i=0;i<n;i++){
Â Â Â Â const start = i*arc + angleOffset;
Â Â Â Â const end = start + arc;

Â Â Â Â // æ‰‡å½¢
Â Â Â Â ctx.beginPath();
Â Â Â Â ctx.moveTo(cx,cy);
Â Â Â Â ctx.arc(cx,cy,r,start,end);
Â Â Â Â ctx.closePath();
Â Â Â Â ctx.fillStyle = colors[i];
Â Â Â Â ctx.fill();

Â Â Â Â // æ–‡æ¡ˆï¼ˆé»‘è‰²ï¼‰
Â Â Â Â ctx.save();
Â Â Â Â ctx.translate(cx,cy);
Â Â Â Â ctx.rotate(start + arc/2);
Â Â Â Â ctx.textAlign = "right";
Â Â Â Â ctx.textBaseline = "middle";
Â Â Â Â ctx.fillStyle = "#000";
Â Â Â Â ctx.font = "bold 16px Arial, 'Noto Sans SC', sans-serif";
Â Â Â Â ctx.fillText(prizes[i], r-20, 0);
Â Â Â Â ctx.restore();
Â Â }
}
drawWheel();

/* ===== æŠ½å¥– ===== */
spinBtn.addEventListener('click', () => {
Â Â if (totalChances() <= 0) {
Â Â Â Â const msg = "æ¯ 3 å¤© 1 æ¬¡ã€‚å¯é€šè¿‡è®¢é˜…/åˆ†äº«è·å¾— +1 æ¬¡ã€‚/ No more chances. Subscribe or Share to get +1.";
Â Â Â Â if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg); else alert(msg);
Â Â Â Â return;
Â Â }

Â Â // æ¶ˆè€—æ¬¡æ•°ï¼šä¼˜å…ˆç”¨å¥–åŠ±ï¼Œå…¶æ¬¡ç”¨åŸºç¡€åé¢
Â Â if (bonusSpins > 0) {
Â Â Â Â bonusSpins--;
Â Â } else {
Â Â Â Â lastSpinAt = Date.now();
Â Â }
Â Â saveState();
Â Â updateUI();

Â Â const spinAngle = 360*5 + Math.random()*360; // äº”åœˆä»¥ä¸Š
Â Â const duration = 4200;
Â Â const start = performance.now();

Â Â function step(now){
Â Â Â Â const p = Math.min((now-start)/duration, 1);
Â Â Â Â const ease = 1 - Math.pow(1-p,3); // ç¼“å‡º
Â Â Â Â drawWheel(ease * spinAngle * Math.PI/180);
Â Â Â Â if (p < 1) requestAnimationFrame(step);
Â Â Â Â else onDone(spinAngle);
Â Â }
Â Â requestAnimationFrame(step);
});

function onDone(spinAngleDeg){
Â Â // è®¡ç®—ä¸­å¥–é¡¹ï¼ˆä¸ 12 ç‚¹æ–¹å‘å¯¹é½ï¼‰
Â Â const n = prizes.length;
Â Â const raw = (spinAngleDeg % 360) / 360;Â Â Â Â Â Â Â Â Â Â Â // 0..1
Â Â const idx = (n - 1 - Math.floor(raw * n)) % n;Â Â Â Â // æŒ‡é’ˆåœ¨ä¸Šæ–¹ï¼Œè§’åº¦è¶Šå¤§ç´¢å¼•è¶Šå°
Â Â const result = prizes[idx];

Â Â // å¼¹çª—ï¼ˆä¸­è‹±ï¼‰
Â Â const msg = /Sorry/.test(result)
Â Â Â Â ? "è°¢è°¢å‚ä¸ / Thanks for playing"
Â Â Â Â : "æ­å–œä¸­å¥– / Congratulations!\n" + result;
Â Â if (isTG && Telegram.WebApp.showPopup) {
Â Â Â Â Telegram.WebApp.showPopup({title:"å¹¸è¿è½¬ç›˜ / Lucky Wheel", message:msg, buttons:[{type:'ok', id:'ok'}]});
Â Â } else if (isTG && Telegram.WebApp.showAlert) {
Â Â Â Â Telegram.WebApp.showAlert(msg);
Â Â } else {
Â Â Â Â alert(msg);
Â Â }

Â Â // â€œOne more spin chanceâ€ +1
Â Â if (/One more spin chance/i.test(result)) {
Â Â Â Â bonusSpins++;
Â Â Â Â saveState();
Â Â Â Â updateUI();
Â Â }

Â Â // ===== ğŸ”§ ä¸ŠæŠ¥ä¸­å¥–ç»“æœï¼ˆä¸¤ç§è·¯å¾„ï¼‰ =====
Â Â reportResult(result);
}

/* ===== è®¢é˜… & åˆ†äº«ï¼šå„ +1 ===== */
document.getElementById('subBtn').addEventListener('click', () => {
Â Â if (isTG) Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
Â Â bonusSpins++; saveState(); updateUI();
});
document.getElementById('shareBtn').addEventListener('click', () => {
Â Â try{
Â Â Â Â if (isTG && Telegram.WebApp.shareToStory) {
Â Â Â Â Â Â Telegram.WebApp.shareToStory({text:'PCD Lucky Wheel', widget_link:'https://t.me/pcatdolls'});
Â Â Â Â } else if (isTG) {
Â Â Â Â Â Â Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
Â Â Â Â } else {
Â Â Â Â Â Â window.open('https://t.me/pcatdolls','_blank');
Â Â Â Â }
Â Â } finally {
Â Â Â Â bonusSpins++; saveState(); updateUI();
Â Â }
});

/* ====== ğŸ”§ ä¸ŠæŠ¥å‡½æ•° ======
Â Â Â A. Mini App æ ‡å‡†åšæ³•ï¼šsendData â†’ ä½ çš„æœºå™¨äººæ”¶åˆ°åå†è½¬å‘åˆ°é¢‘é“/ç¾¤
Â Â Â B. å¯é€‰ç›´è¿ Bot APIï¼ˆéœ€å¡«å†™ BOT_TOKEN + TARGET_CHAT_IDï¼›chat_id å¿…é¡»æ˜¯é¢‘é“/ç¾¤/ä½ è‡ªå·±çš„ chatï¼Œä¸æ˜¯ botï¼‰
*/
const BOT_TOKENÂ Â Â = "7779859704:AAHwAPPUhTQQRwVJ1FeGJUuY6BJ5vBmFths";
const TARGET_CHAT_ID = "@pcatdolls69"

function reportResult(result){
Â Â // A) é€šè¿‡ Mini App å›ä¼ ï¼ˆæ¨èï¼‰
Â Â try {
Â Â Â Â if (isTG && Telegram.WebApp.sendData) {
Â Â Â Â Â Â const u = Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user;
Â Â Â Â Â Â const name = u ? ((u.first_name||'') + (u.last_name?(' '+u.last_name):'')) : 'Guest';
Â Â Â Â Â Â const handle = u && u.username ? ('@'+u.username) : '';
Â Â Â Â Â Â Telegram.WebApp.sendData(`Result=${result}; User=${name}${handle?' '+handle:''}`);
Â Â Â Â }
Â Â } catch(e){/* ignore */ }

Â Â // B) ç›´è¿ Bot APIï¼ˆå¯é€‰ï¼‰
Â Â if (BOT_TOKEN && TARGET_CHAT_ID) {
Â Â Â Â fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
Â Â Â Â Â Â method: "POST",
Â Â Â Â Â Â headers: { "Content-Type": "application/json" },
Â Â Â Â Â Â body: JSON.stringify({
Â Â Â Â Â Â Â Â chat_id: TARGET_CHAT_ID,
Â Â Â Â Â Â Â Â text: `ğŸ¯ PCD Lucky Wheel\nResult: ${result}`
Â Â Â Â Â Â })
Â Â Â Â }).catch(()=>{});
Â Â }
}
</script>
</body>
</html>
