<!DOCTYPE html>
<html lang="zh-Hans">
<head>
Â Â <meta charset="UTF-8">
Â Â <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
Â Â <title>PCD Lucky Wheel</title>
Â Â <style>
Â Â Â Â body{
Â Â Â Â Â Â margin:0; background:#fff; color:#333;
Â Â Â Â Â Â font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
Â Â Â Â Â Â display:flex; flex-direction:column; align-items:center; justify-content:center;
Â Â Â Â Â Â height:100vh; overflow:hidden;
Â Â Â Â Â Â -webkit-tap-highlight-color:transparent; user-select:none;
Â Â Â Â }
Â Â Â Â h2{margin:6px 0 12px; text-align:center}
Â Â Â Â .container{position:relative; display:flex; flex-direction:column; align-items:center}
Â Â Â Â /* ç”»å¸ƒï¼šå…ˆç»™ä¿é™©å°ºå¯¸ï¼ŒJS ä¼šå†è°ƒæ•´é«˜æ¸…åƒç´ æ¯”ä¾‹ */
Â Â Â Â #wheelCanvas{
Â Â Â Â Â Â background:#fff; border-radius:50%;
Â Â Â Â Â Â width:340px; height:340px;
Â Â Â Â Â Â box-shadow: inset 0 0 0 10px rgba(107,35,157,.15), 0 6px 12px rgba(0,0,0,.08);
Â Â Â Â Â Â display:block;
Â Â Â Â }
Â Â Â Â /* æ·±ç´«è‰²æŒ‡é’ˆå›ºå®š 12 ç‚¹ */
Â Â Â Â .pointer{
Â Â Â Â Â Â position:absolute; top:calc(50% - 195px); left:50%; transform:translateX(-50%);
Â Â Â Â Â Â width:0; height:0; border-left:15px solid transparent; border-right:15px solid transparent; border-bottom:25px solid #5c1898;
Â Â Â Â Â Â z-index:10; filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
Â Â Â Â }
Â Â Â Â /* ä¸­å¤®æ·±ç´«åœ†å¿ƒï¼ˆä¸è½¬åŠ¨ï¼Œä»…è£…é¥°ï¼Œå¯å»æ‰ï¼‰ */
Â Â Â Â .hub{
Â Â Â Â Â Â position:absolute; inset:auto; left:50%; top:50%; transform:translate(-50%,-50%);
Â Â Â Â Â Â width:24%; aspect-ratio:1/1; border-radius:50%;
Â Â Â Â Â Â background:#5c1898; box-shadow:0 2px 6px rgba(0,0,0,.18) inset, 0 0 0 10px #fff; z-index:2; pointer-events:none;
Â Â Â Â }
Â Â Â Â /* æŒ‰é’®ï¼šæ·¡ç²‰è‰²ï¼Œç½®äºè½¬ç›˜æ­£ä¸‹æ–¹ */
Â Â Â Â #spinBtn{
Â Â Â Â Â Â margin-top:16px; padding:10px 20px; border:none; border-radius:10px;
Â Â Â Â Â Â background:#f7d3e8; color:#4b0c7a; font-weight:700; font-size:16px; cursor:pointer;
Â Â Â Â }
Â Â Â Â #spinBtn:disabled{opacity:.6; cursor:not-allowed}
Â Â Â Â .chances{margin-top:6px; font-size:14px}
Â Â Â Â .note{margin-top:18px; width:92%; text-align:center; font-size:12px; line-height:1.5; color:#444}
Â Â Â Â .note a{color:#6b00c8; text-decoration:none; font-weight:700}
Â Â Â Â .links{margin-top:8px}
Â Â Â Â .links a{margin:0 10px}
Â Â </style>
</head>
<body>
Â Â <h2>PCD Lucky Wheel<br><small>å¹¸è¿è½¬ç›˜ Â· Lucky Draw</small></h2>

Â Â <div class="container">
Â Â Â Â <div class="pointer" aria-hidden="true"></div>
Â Â Â Â <canvas id="wheelCanvas" width="340" height="340"></canvas>
Â Â Â Â <div class="hub" aria-hidden="true"></div>
Â Â </div>

Â Â <!-- æŒ‰é’®ï¼ˆä¸­è‹±å¯¹ç…§ï¼‰ -->
Â Â <button id="spinBtn">ğŸ¯ å¼€å§‹ / Start</button>
Â Â <div class="chances" id="chances">å‰©ä½™æ¬¡æ•° / Chances: --</div>

Â Â <!-- åªæœ‰æœ€ä¸‹é¢åŒºåŸŸåšä¸­è‹±å¯¹ç…§ -->
Â Â <div class="note">
Â Â Â Â <div class="links">
Â Â Â Â Â Â <a id="subLink" href="#">è®¢é˜… / Subscribe</a> Â·
Â Â Â Â Â Â <a id="shareLink" href="#">åˆ†äº« / Share</a>
Â Â Â Â </div>
Â Â Â Â âš ï¸ æ‰€æœ‰å¥–é¡¹ä¸èƒ½é‡å ä½¿ç”¨ Â· Prizes cannot be combined<br>
Â Â Â Â è®¢é˜…å¹¶åˆ†äº«é¢‘é“å¯å¤šä¸€æ¬¡æœºä¼š / Subscribe &amp; Share for +1 spin
Â Â </div>

Â Â <!-- å…ˆè½½ TweenMaxï¼Œå†è½½ Winwheelï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰ -->
Â Â <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
Â Â <script src="https://cdn.jsdelivr.net/npm/winwheel@2.8.0/Winwheel.min.js"></script>

Â Â <script>
Â Â Â Â // é¢œè‰²ï¼ˆç²‰ã€ç´«ã€è“ã€é»„ï¼›å¯¹æ¯”æ¸…æ¥šï¼‰
Â Â Â Â const C = ['#ffd1e8','#cbb2fe','#b6e1ff','#ffe07a'];

Â Â Â Â // 9 ä¸ªå¥–é¡¹
Â Â Â Â const SEGMENTS = [
Â Â Â Â Â Â { fillStyle:C[0], text:'45â° or 60â°/ 10 off' },
Â Â Â Â Â Â { fillStyle:C[1], text:'45â° or 60â°/ 20 off' },
Â Â Â Â Â Â { fillStyle:C[2], text:'One more spin chance' },
Â Â Â Â Â Â { fillStyle:C[3], text:'45â° or 60â°/ 10 off' },
Â Â Â Â Â Â { fillStyle:C[0], text:'Sorry ğŸ˜¢' },
Â Â Â Â Â Â { fillStyle:C[1], text:'45â° or 60â°/ 20 off' },
Â Â Â Â Â Â { fillStyle:C[2], text:'Sorry ğŸ˜¢' },
Â Â Â Â Â Â { fillStyle:C[3], text:'45â° or 60â°/ 40 off' },
Â Â Â Â Â Â { fillStyle:C[0], text:'Sorry ğŸ˜¢' }
Â Â Â Â ];

Â Â Â Â // DOM
Â Â Â Â const canvas = document.getElementById('wheelCanvas');
Â Â Â Â const btn = document.getElementById('spinBtn');
Â Â Â Â const chancesEl = document.getElementById('chances');
Â Â Â Â const subLink = document.getElementById('subLink');
Â Â Â Â const shareLink = document.getElementById('shareLink');

Â Â Â Â // Telegram ç¯å¢ƒ
Â Â Â Â const isTG = !!(window.Telegram && Telegram.WebApp);
Â Â Â Â if (isTG) { Telegram.WebApp.ready(); }

Â Â Â Â // èº«ä»½ä¸æœ¬åœ°å­˜å‚¨ï¼ˆæ¯ 3 å¤© 1 æ¬¡ + bonusï¼‰
Â Â Â Â const TG_USER = (isTG && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) || null;
Â Â Â Â const USER_ID = TG_USER ? String(TG_USER.id) : 'guest';
Â Â Â Â const STORAGE_KEY = 'pcd_wheel_' + USER_ID; // { lastBaseSpinISO: string|null, bonus: number }

Â Â Â Â function readState(){
Â Â Â Â Â Â try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { lastBaseSpinISO:null, bonus:0 }; }
Â Â Â Â Â Â catch(e){ return { lastBaseSpinISO:null, bonus:0 }; }
Â Â Â Â }
Â Â Â Â function writeState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

Â Â Â Â function baseAvailable(now=new Date()){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â if (!st.lastBaseSpinISO) return true; // ä»æœªç”¨è¿‡ï¼Œç»™ 1 æ¬¡
Â Â Â Â Â Â return (now - new Date(st.lastBaseSpinISO)) >= 3*24*60*60*1000; // 3 å¤©
Â Â Â Â }
Â Â Â Â function totalChances(){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â return (baseAvailable()?1:0) + (st.bonus|0);
Â Â Â Â }
Â Â Â Â function consumeChance(){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â if (st.bonus > 0) st.bonus -= 1;
Â Â Â Â Â Â else st.lastBaseSpinISO = new Date().toISOString();
Â Â Â Â Â Â writeState(st);
Â Â Â Â }
Â Â Â Â function addBonus(n=1){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â st.bonus = (st.bonus|0) + n;
Â Â Â Â Â Â writeState(st);
Â Â Â Â }
Â Â Â Â function updateChances(){
Â Â Â Â Â Â chancesEl.textContent = 'å‰©ä½™æ¬¡æ•° / Chances: ' + totalChances();
Â Â Â Â Â Â btn.disabled = totalChances() <= 0;
Â Â Â Â }

Â Â Â Â // è®¢é˜…/åˆ†äº«ï¼šå„ +1 æ¬¡ï¼ˆåº•éƒ¨é“¾æ¥ï¼‰
Â Â Â Â function wireBonusLinks(){
Â Â Â Â Â Â subLink.addEventListener('click', function(e){
Â Â Â Â Â Â Â Â e.preventDefault();
Â Â Â Â Â Â Â Â if (isTG) Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
Â Â Â Â Â Â Â Â addBonus(1); updateChances();
Â Â Â Â Â Â });
Â Â Â Â Â Â shareLink.addEventListener('click', function(e){
Â Â Â Â Â Â Â Â e.preventDefault();
Â Â Â Â Â Â Â Â try{
Â Â Â Â Â Â Â Â Â Â if (isTG && Telegram.WebApp.shareToStory) {
Â Â Â Â Â Â Â Â Â Â Â Â Telegram.WebApp.shareToStory({ text:'PCD Lucky Wheel', widget_link:'https://t.me/pcatdolls' });
Â Â Â Â Â Â Â Â Â Â } else if (isTG) {
Â Â Â Â Â Â Â Â Â Â Â Â Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â } finally {
Â Â Â Â Â Â Â Â Â Â addBonus(1); updateChances();
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â });
Â Â Â Â }

Â Â Â Â // åˆ›å»ºè½®ç›˜
Â Â Â Â let wheel = null;
Â Â Â Â function createWheel(){
Â Â Â Â Â Â // é«˜ DPI å¤„ç†ï¼ˆç¡®ä¿æ¸…æ™°ï¼‰
Â Â Â Â Â Â const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
Â Â Â Â Â Â const cssSize = Math.min(460, Math.max(300, canvas.clientWidth)); // ä¿å®ˆèŒƒå›´
Â Â Â Â Â Â canvas.width = cssSize * DPR;
Â Â Â Â Â Â canvas.height = cssSize * DPR;
Â Â Â Â Â Â canvas.style.width = cssSize + 'px';
Â Â Â Â Â Â canvas.style.height = cssSize + 'px';
Â Â Â Â Â Â const ctx = canvas.getContext('2d');
Â Â Â Â Â Â ctx.setTransform(DPR,0,0,DPR,0,0);

Â Â Â Â Â Â wheel = new Winwheel({
Â Â Â Â Â Â Â Â canvasId:'wheelCanvas',
Â Â Â Â Â Â Â Â numSegments:SEGMENTS.length,
Â Â Â Â Â Â Â Â outerRadius: (cssSize/2) - 12, // ç•™å¤–åœˆ
Â Â Â Â Â Â Â Â textFontSize: 14,
Â Â Â Â Â Â Â Â textFillStyle: '#333',
Â Â Â Â Â Â Â Â segments: SEGMENTS,
Â Â Â Â Â Â Â Â animation:{
Â Â Â Â Â Â Â Â Â Â type:'spinToStop', duration:5, spins:8,
Â Â Â Â Â Â Â Â Â Â callbackFinished:onFinished
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â });
Â Â Â Â }

Â Â Â Â // ç‚¹å‡»å¼€å§‹
Â Â Â Â btn.addEventListener('click', () => {
Â Â Â Â Â Â if (totalChances() <= 0) {
Â Â Â Â Â Â Â Â const msg = 'æ¯äºº 3 å¤©å¯è½¬ 1 æ¬¡ï¼›è®¢é˜…/åˆ†äº«æˆ–æŠ½åˆ°ã€ŒOne more spin chanceã€å¯ +1 æ¬¡ã€‚\nOne spin every 3 days. Subscribe/Share or landing on the bonus tile grants +1 chance.';
Â Â Â Â Â Â Â Â if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg);
Â Â Â Â Â Â Â Â else alert(msg);
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â Â Â consumeChance(); updateChances();
Â Â Â Â Â Â btn.textContent = 'ğŸ° æ—‹è½¬ä¸­ / Spinningâ€¦'; btn.disabled = true;
Â Â Â Â Â Â wheel.startAnimation();
Â Â Â Â Â Â setTimeout(()=>{ btn.textContent = 'ğŸ¯ å¼€å§‹ / Start'; btn.disabled = totalChances()<=0; }, 5200);
Â Â Â Â });

Â Â Â Â // å®Œæˆå›è°ƒ
Â Â Â Â function onFinished(seg){
Â Â Â Â Â Â const result = seg?.text || '';
Â Â Â Â Â Â if (/One more spin chance/i.test(result)) {
Â Â Â Â Â Â Â Â addBonus(1); updateChances();
Â Â Â Â Â Â Â Â notify('è·å¾— +1 æ¬¡æœºä¼š Â· +1 extra chance');
Â Â Â Â Â Â } else if (/Sorry/i.test(result)) {
Â Â Â Â Â Â Â Â notify('è°¢è°¢å‚ä¸ Â· Thanks for playing');
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â notify('æ­å–œä¸­å¥–ï¼š' + result + '\nCongratulations!');
Â Â Â Â Â Â }

Â Â Â Â Â Â // å›ä¼ ç»™ @pcd_luckywheel_botï¼šæŠ½å¥–è€…åå­— + ç»“æœ
Â Â Â Â Â Â const u = TG_USER;
Â Â Â Â Â Â const name = u ? ((u.first_name || '') + (u.last_name ? (' ' + u.last_name) : '')) : 'Guest';
Â Â Â Â Â Â const handle = u && u.username ? ('@' + u.username) : '';
Â Â Â Â Â Â const payload = `Winner: ${name}${handle ? ' ' + handle : ''} | Result: ${result}`;
Â Â Â Â Â Â if (isTG && Telegram.WebApp.sendData) { try { Telegram.WebApp.sendData(payload); } catch(e){} }

Â Â Â Â Â Â // è§¦è§‰ï¼ˆæ”¯æŒæ—¶ï¼‰
Â Â Â Â Â Â try{ if (isTG && Telegram.WebApp.HapticFeedback) Telegram.WebApp.HapticFeedback.notificationOccurred('success'); }catch(e){}
Â Â Â Â }

Â Â Â Â function notify(message){
Â Â Â Â Â Â if (isTG && Telegram.WebApp.showPopup) {
Â Â Â Â Â Â Â Â Telegram.WebApp.showPopup({ title:'PCD Lucky Wheel', message, buttons:[{type:'ok', id:'ok'}] });
Â Â Â Â Â Â } else if (isTG && Telegram.WebApp.showAlert) {
Â Â Â Â Â Â Â Â Telegram.WebApp.showAlert(message);
Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â alert(message);
Â Â Â Â Â Â }
Â Â Â Â }

Â Â Â Â // åˆå§‹åŒ–ï¼ˆå»¶è¿Ÿï¼Œé¿å… WebView å°ºå¯¸æœªç¨³å®šï¼‰
Â Â Â Â function init(){
Â Â Â Â Â Â wireBonusLinks();
Â Â Â Â Â Â createWheel();
Â Â Â Â Â Â updateChances();
Â Â Â Â }
Â Â Â Â window.addEventListener('load', () => setTimeout(init, 300));
Â Â </script>
</body>
</html>
