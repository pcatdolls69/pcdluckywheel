<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PCD Lucky Wheel</title>
<style>
:root{
  --brand:#6e2b74;
  --shadow:0 8px 30px rgba(0,0,0,.15);
}
body{
  margin:0;
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:linear-gradient(180deg,#f8e7ff,#ffe6f2,#d9ecff);
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;
  color:#333;
}
.card{
  background:#fff;
  border-radius:20px;
  box-shadow:var(--shadow);
  padding:20px;
  width:95%;
  max-width:420px;
  text-align:center;
}
canvas{
  width:100%;
  height:auto;
  border-radius:50%;
  box-shadow:inset 0 0 0 12px #f3e4ff;
}
.pointer{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-58%);
  width:60px;
  height:60px;
  border-radius:50%;
  background:radial-gradient(circle,#fff 40%,var(--brand) 45%);
  z-index:10;
}
.pointer::before{
  content:"";
  position:absolute;
  top:-8px;
  left:50%;
  transform:translateX(-50%);
  width:0;
  height:0;
  border-left:12px solid transparent;
  border-right:12px solid transparent;
  border-bottom:18px solid var(--brand);
}
button{
  margin-top:18px;
  padding:12px 24px;
  font-size:18px;
  font-weight:600;
  background:linear-gradient(135deg,#f7d1ff,#ffd1d1);
  border:none;
  border-radius:16px;
  cursor:pointer;
  color:#5a1c6d;
  box-shadow:var(--shadow);
}
button:disabled{opacity:.6;cursor:not-allowed;}
#status{margin-top:10px;font-size:15px;color:#666;}
.chips{display:flex;justify-content:center;gap:10px;margin-top:12px;}
.chip{
  background:#fff;
  box-shadow:var(--shadow);
  border-radius:14px;
  padding:10px 14px;
  font-size:14px;
  font-weight:600;
}
.footer{
  font-size:13px;
  color:#777;
  margin-top:16px;
  line-height:1.5;
}
</style>
</head>
<body>
<div class="card">
  <div style="position:relative;">
    <canvas id="wheel" width="350" height="350"></canvas>
    <div class="pointer"></div>
  </div>
  <button id="spinBtn">🎡 Start Spin</button>
  <div id="status"></div>

  <div class="chips">
    <div id="subBtn" class="chip">✅ Subscribe</div>
    <div id="shareBtn" class="chip">🔗 Share</div>
  </div>

  <div class="footer">
    ⚠️ 所有奖项不能重叠使用<br>
    (All rewards cannot be combined)<br>
    订阅并分享频道可多一次机会 / Subscribe & Share for +1 spin<br>
    <a href="https://t.me/pcatdolls" target="_blank">🔗 订阅 / Subscribe</a>
  </div>
</div>

<script>
const prizes = [
  "45⏰ or 60⏰ / 10 off",
  "45⏰ or 60⏰ / 20 off",
  "🎁 One more spin chance",
  "45⏰ or 60⏰ / 10 off",
  "Sorry 😢",
  "45⏰ or 60⏰ / 20 off",
  "Sorry 😢",
  "45⏰ or 60⏰ / 40 off",
  "Sorry 😢"
];

const colors = [
  "#ffd8e8","#e2d6ff","#d9f0ff","#fff6c2",
  "#fbd1ff","#d6eaff","#ffead1","#f4dfff","#ffddee"
];

const wheel = document.getElementById("wheel");
const ctx = wheel.getContext("2d");
const n = prizes.length;
const angleStep = 2 * Math.PI / n;
let rotation = 0;
let spinning = false;

function drawWheel(){
  const r = wheel.width / 2;
  ctx.clearRect(0,0,wheel.width,wheel.height);
  ctx.save();
  ctx.translate(r,r);
  ctx.rotate(-Math.PI/2);
  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.fillStyle = colors[i%colors.length];
    ctx.arc(0,0,r,i*angleStep,(i+1)*angleStep);
    ctx.fill();
    ctx.save();
    ctx.rotate(i*angleStep+angleStep/2);
    ctx.textAlign="center";
    ctx.fillStyle="#333";
    ctx.font="bold 14px Arial";
    ctx.translate(r*0.7,0);
    ctx.rotate(Math.PI/2);
    wrapText(ctx,prizes[i],0,0,r*0.4,16);
    ctx.restore();
  }
  ctx.restore();
}

function wrapText(ctx,text,x,y,maxWidth,lineHeight){
  const words=text.split(" ");
  let line="",yy=y;
  for(let w of words){
    const test=line+w+" ";
    if(ctx.measureText(test).width>maxWidth && line){
      ctx.fillText(line,x,yy);
      line=w+" ";
      yy+=lineHeight;
    } else line=test;
  }
  ctx.fillText(line,x,yy);
}

function periodKey(){
  const d=new Date();
  return Math.floor(d.getTime()/(3*86400000)); // 3 days
}

const KEY="pcd_wheel_v3";
function loadState(){
  const s=JSON.parse(localStorage.getItem(KEY)||"{}");
  if(s.period!==periodKey()) return {period:periodKey(),used:0,sub:false,share:false};
  return s;
}
let state=loadState();
function save(){localStorage.setItem(KEY,JSON.stringify(state));}
function allowance(){return 1+(state.sub&&state.share?1:0);}
function remaining(){return Math.max(0,allowance()-state.used);}
function updateStatus(){
  document.getElementById("status").innerHTML=`剩余次数 / Spins left: ${remaining()}`;
}

function spin(){
  if(spinning || remaining()<=0) return alert("No spins left!");
  spinning=true;
  const index=Math.floor(Math.random()*n);
  const target=-Math.PI/2 - (index*angleStep+angleStep/2);
  const extra=2*Math.PI*5;
  const finalRot=rotation+extra+target;
  const start=performance.now(),duration=4200;
  const step=t=>{
    const p=Math.min(1,(t-start)/duration);
    const ease=1-Math.pow(1-p,3);
    rotation+= (finalRot-rotation)*ease;
    drawWheel();
    if(p<1) requestAnimationFrame(step);
    else{
      rotation%=2*Math.PI;
      const result=prizes[index];
      finish(result);
    }
  };
  requestAnimationFrame(step);
}

function finish(result){
  if(result.includes("One more spin")){
    alert("🎁 One more spin added!");
  } else {
    state.used++;
    alert("🎉 Result: "+result);
  }
  save();updateStatus();
  if(window.Telegram?.WebApp){
    window.Telegram.WebApp.sendData(JSON.stringify({
      result,used:state.used,remaining:remaining(),
      subscribed:state.sub,shared:state.share,
      period:periodKey(),lang:navigator.language
    }));
  }
  spinning=false;
  document.getElementById("spinBtn").disabled = remaining()<=0;
}

document.getElementById("spinBtn").onclick=spin;
document.getElementById("subBtn").onclick=()=>{
  window.open("https://t.me/pcatdolls","_blank");
  state.sub=true;save();updateStatus();
};
document.getElementById("shareBtn").onclick=()=>{
  window.open(`https://t.me/share/url?url=${encodeURIComponent(location.href)}&text=🎡PCD+Lucky+Wheel`,"_blank");
  state.share=true;save();updateStatus();
};

drawWheel();updateStatus();
</script>
</body>
</html>
