<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PCD Lucky Wheel — CN/EN</title>
<style>
:root {
  --brand: #6e2b74;
  --ring: #eadcf3;
  --card: #ffffff;
  --bg1: #fbf1ff;
  --grad1: #f7d1ff;
  --grad2: #ffd1d1;
  --shadow: 0 6px 16px rgba(0,0,0,0.1);
  --text: #2b2b2b;
  --muted: #7d7d7d;
}
*{box-sizing:border-box;}
body {
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;margin:0;background:radial-gradient(800px at 50% -150px,var(--bg1),#fff);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'PingFang SC',sans-serif;
  color:var(--text);
}
.card {
  background:var(--card);
  border-radius:26px;
  box-shadow:var(--shadow);
  padding:24px 18px 28px;
  width:min(600px,92vw);
}
.stage {
  position:relative;background:#fff;border-radius:20px;padding:18px;
  box-shadow:inset 0 0 0 2px #f2e9f7;
}
.wheelWrap {
  width:100%;aspect-ratio:1/1;position:relative;
}
canvas {
  width:100%;height:100%;border-radius:50%;
  box-shadow:inset 0 0 0 14px var(--ring),inset 0 0 0 3px #fff;
}
.center-pointer {
  position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:22%;aspect-ratio:1/1;border-radius:50%;
  background:radial-gradient(circle,#fff 35%,#fff 36%,var(--brand) 36%,var(--brand) 100%);
}
.center-pointer::before {
  content:"";position:absolute;top:8%;left:50%;transform:translate(-50%,-50%);
  border-left:10px solid transparent;border-right:10px solid transparent;
  border-bottom:16px solid var(--brand);
}
.actions {display:flex;justify-content:center;margin:20px 0 8px;}
.btn {
  background:linear-gradient(180deg,#f7d1ff,#ffd1d1);
  color:#632d79;border:0;border-radius:18px;
  padding:12px 28px;font-size:20px;font-weight:700;cursor:pointer;
  box-shadow:var(--shadow);
}
.btn:disabled {opacity:0.6;cursor:not-allowed;}
.chipRow {display:flex;justify-content:center;gap:12px;margin:10px 0;}
.chip {
  display:flex;align-items:center;gap:8px;padding:10px 16px;
  background:#fff;border-radius:16px;font-weight:600;
  box-shadow:var(--shadow);
}
.chip .dot {font-size:20px;}
.muted {color:var(--muted);font-size:14px;text-align:center;line-height:1.6;}
.status {margin-top:8px;}
</style>
</head>
<body>
<div class="card">
  <div class="stage">
    <div class="wheelWrap">
      <canvas id="wheel"></canvas>
      <div class="center-pointer"></div>
    </div>
  </div>

  <div class="actions">
    <button id="startBtn" class="btn">开始 / Start</button>
  </div>

  <div class="chipRow">
    <button id="subBtn" class="chip"><span class="dot">✅</span>订阅 / Subscribe</button>
    <button id="shareBtn" class="chip"><span class="dot">🔗</span>分享 / Share</button>
  </div>

  <div class="muted">
    🌟 每 3 天 1 次；完成订阅 + 分享 再 +1；抽到 🎁 one more chance 再 +1<br>
    (Every 3 days 1 spin; +1 after subscribing + sharing; +1 on 🎁 one more chance)
  </div>
  <div id="status" class="muted status"></div>
</div>

<script>
(() => {
  const prizes = [
    "1 😢 sorry",
    "45⏰ or 60⏰ / 10 off",
    "3 😢 sorry",
    "45⏰ or 60⏰ / 20 off",
    "🎁 one more chance",
    "8 😢 sorry",
    "45⏰ or 60⏰ / 40 off",
    "5 😢 sorry",
    "45⏰ or 60⏰ / 10 off"
  ];
  const segColors = ["#dbe7ff","#ffd7d7","#d6f9ff","#ffe5b8","#fff0c2","#e3d8ff","#ffd7d7","#d6f9ff","#ffd1e1"];
  const n = prizes.length;
  const wheel = document.getElementById("wheel");
  const ctx = wheel.getContext("2d");
  const DPR = window.devicePixelRatio || 1;
  const size = 600;
  wheel.width = wheel.height = size * DPR;
  ctx.scale(DPR, DPR);
  const R = size/2 * 0.8;
  const CX = size/2, CY = size/2;
  const segmentAngle = 2*Math.PI / n;
  let currentRotation = 0;

  function drawWheel(){
    ctx.clearRect(0,0,size,size);
    ctx.save();
    ctx.translate(CX,CY);
    ctx.rotate(-Math.PI/2);
    for(let i=0;i<n;i++){
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.fillStyle = segColors[i%segColors.length];
      ctx.arc(0,0,R,i*segmentAngle,(i+1)*segmentAngle);
      ctx.closePath(); ctx.fill();

      ctx.save();
      ctx.rotate(i*segmentAngle + segmentAngle/2);
      ctx.textAlign="center";
      ctx.fillStyle="#2b2b2b";
      ctx.font="18px Arial";
      ctx.translate(R*0.7,0);
      ctx.rotate(Math.PI/2);
      wrapText(ctx,prizes[i],0,0,R*0.35,22);
      ctx.restore();
    }
    ctx.restore();
  }

  function wrapText(ctx,text,x,y,maxWidth,lineHeight){
    const words=text.split(' ');let line='',yy=y;
    for(let w of words){
      const test=line+w+' ';
      if(ctx.measureText(test).width>maxWidth && line){
        ctx.fillText(line,x,yy);line=w+' ';yy+=lineHeight;
      }else line=test;
    }
    ctx.fillText(line,x,yy);
  }

  // ----- Logic -----
  const TG = window.Telegram?.WebApp;
  if(TG){TG.expand();TG.ready();}
  const KEY="pcd_luckywheel_v2";
  const PERIOD_DAYS=3;
  function periodKey(){
    const d=new Date();
    return Math.floor(d.getTime()/(PERIOD_DAYS*86400000));
  }
  function loadState(){
    const s=JSON.parse(localStorage.getItem(KEY)||"{}");
    if(s.period!==periodKey()) return {period:periodKey(),used:0,subscribed:false,shared:false};
    return s;
  }
  let state=loadState();
  function save(){localStorage.setItem(KEY,JSON.stringify(state));}
  function allowance(){return 1+(state.subscribed&&state.shared?1:0);}
  function remaining(){return Math.max(0,allowance()-state.used);}
  function updateStatus(){
    const sub=state.subscribed?"✅":"❌",shr=state.shared?"✅":"❌";
    status.innerHTML=`剩餘次數：${remaining()}（週期：每 ${PERIOD_DAYS} 天）<br>
    Allowance: ${allowance()} (used ${state.used}) · subscribe/share: ${sub}/${shr}`;
  }

  function spin(){
    if(remaining()<=0){alert("次數已用完 / No spins left");return;}
    startBtn.disabled=true;
    const targetIndex=Math.floor(Math.random()*n);
    const targetAngle=-Math.PI/2 - (targetIndex*segmentAngle+segmentAngle/2);
    const extra=2*Math.PI*6;
    const finalRot=currentRotation+extra+targetAngle;
    const start=performance.now(),duration=4200;
    function animate(t){
      const p=Math.min(1,(t-start)/duration);
      const ease=1-Math.pow(1-p,3);
      currentRotation=currentRotation+(finalRot-currentRotation)*ease;
      drawWheel();
      if(p<1) requestAnimationFrame(animate);
      else{
        currentRotation%=2*Math.PI;
        drawWheel();
        const idx=(n - Math.floor((currentRotation/(2*Math.PI))*n))%n;
        finish(idx);
      }
    }
    requestAnimationFrame(animate);
  }

  function finish(idx){
    const result=prizes[idx];
    if(result.includes("one more chance")){
      alert("🎁 再來一次! +1 機會 / One more chance!");
      state.used=Math.max(0,state.used-1);
    }else{
      alert("🎉 恭喜中獎 / Congratulations!\n"+result);
      state.used++;
    }
    save();updateStatus();
    if(TG){
      TG.sendData(JSON.stringify({
        event:"spin_result",result,index:idx,
        used:state.used,baseAllowance:1,bonus:allowance()-1,
        remaining:remaining(),
        subscribed:state.subscribed,shared:state.shared,
        periodDays:PERIOD_DAYS,periodKey:periodKey(),
        lang:navigator.language,ts:Date.now(),version:"v2.1"
      }));
    }
    startBtn.disabled=remaining()<=0;
  }

  const startBtn=document.getElementById("startBtn");
  const subBtn=document.getElementById("subBtn");
  const shareBtn=document.getElementById("shareBtn");
  startBtn.onclick=spin;
  subBtn.onclick=()=>{window.open("https://t.me/pcatdolls","_blank");state.subscribed=true;save();updateStatus();};
  shareBtn.onclick=()=>{window.open(`https://t.me/share/url?url=${encodeURIComponent(location.href)}&text=PCD+Lucky+Wheel`,"_blank");state.shared=true;save();updateStatus();};

  drawWheel();updateStatus();
})();
</script>
</body>
</html>
