<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>幸運轉盤</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #fff0f5;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: start;
    height: 100vh;
    color: #333;
  }
  h2 {
    margin-top: 10px;
  }
  #wheel-container {
    position: relative;
    width: 90vw;
    max-width: 400px;
    height: 90vw;
    max-height: 400px;
    margin-top: 20px;
  }
  canvas {
    width: 100%;
    height: 100%;
  }
  #pointer {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0; 
    height: 0; 
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 20px solid #4B0082; /* 深紫色指針 */
    z-index: 10;
  }
  #spinBtn {
    margin-top: 20px;
    padding: 12px 24px;
    background-color: #ff69b4;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
  }
  #spinBtn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  #status {
    margin-top: 10px;
    font-size: 14px;
  }
  #footer {
    margin-top: 20px;
    font-size: 12px;
    text-align: center;
  }
  #footer a {
    color: #007bff;
    text-decoration: none;
  }
</style>
</head>
<body>

<h2>幸运转盘 / Lucky Wheel</h2>
<div id="wheel-container">
  <div id="pointer"></div>
  <canvas id="wheel" width="400" height="400"></canvas>
</div>
<button id="spinBtn">旋转 / Spin</button>
<div id="status">剩余抽奖次数 / Remaining chances: <span id="chances">3</span></div>
<div id="footer">
  ⚠️所有奖项不能重复使用 / All prizes cannot be used together<br/>
  <a href="https://t.me/pcatdolls" target="_blank">订阅/Subscribe & Share Channel</a> / Subscribe and share channel
</div>

<script>
const prizes = [
  { text: "45⏰ or 60⏰ / 10 off", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: false },
  { text: "45⏰ or 60⏰ / 20 off", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: false },
  { text: "One more spin chance", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: true },
  { text: "45⏰ or 60⏰ / 10 off", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: false },
  { text: "Sorry 😢", color: ["#ffd700","#ffb6c1","#add8e6","#ffff66"], special: false },
  { text: "45⏰ or 60⏰ / 20 off", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: false },
  { text: "Sorry 😢", color: ["#ffd700","#ffb6c1","#add8e6","#ffff66"], special: false },
  { text: "45⏰ or 60⏰ / 40 off", color: ["#ff69b4","#dda0dd","#87cefa","#ffff66"], special: false },
  { text: "Sorry 😢", color: ["#ffd700","#ffb6c1","#add8e6","#ffff66"], special: false },
];

let chances = 3;
let extraSpin = 0; // 由"One more spin"獎項獲得
let lastSpinDate = null;

// 儲存中獎結果
let lastPrize = null;

// 初始化轉盤
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');

function drawWheel() {
  const total = prizes.length;
  const startAngle = 0;
  const arc = Math.PI * 2 / total;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const radius = Math.min(canvas.width/2, canvas.height/2);
  for(let i=0; i<total; i++) {
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.fillStyle = prizes[i].color[Math.floor(Math.random()*prizes[i].color.length)];
    ctx.arc(0, 0, radius, startAngle + i*arc, startAngle + (i+1)*arc);
    ctx.lineTo(0,0);
    ctx.fill();

    // 文字
    ctx.rotate(startAngle + (i+0.5)*arc);
    ctx.textAlign = "right";
    ctx.font = "14px Arial";
    ctx.fillStyle = "#fff";
    ctx.fillText(prizes[i].text, radius - 10, 8);
    ctx.restore();
  }
}
drawWheel();

function getPrizeIndex(angle) {
  const total = prizes.length;
  const arc = Math.PI * 2 / total;
  let index = Math.floor(((angle + Math.PI*2) % (Math.PI*2)) / arc);
  return index;
}

function spin() {
  if (chances <= 0) {
    alert("没有剩余次数 / No chances left");
    return;
  }
  chances--;
  document.getElementById('chances').innerText = chances + extraSpin;

  const spinDegree = Math.random() * 360 + 360 * 4; // 最少轉4圈
  const start = performance.now();
  const duration = 4000; // 轉動時間
  const animate = (now) => {
    const elapsed = now - start;
    const progress = Math.min(elapsed / duration, 1);
    const easeProgress = 1 - Math.pow(1 - progress, 3); // 漸進
    const currentDegree = easeProgress * spinDegree;
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(currentDegree * Math.PI / 180);
    ctx.translate(-canvas.width/2, -canvas.height/2);
    drawWheel();
    ctx.restore();
    if (progress < 1) {
      requestAnimationFrame(animate);
    } else {
      // 判斷獎項
      const finalAngle = (currentDegree % 360);
      const prizeIdx = getPrizeIndex(finalAngle * Math.PI/180);
      const prize = prizes[prizeIdx];
      lastPrize = prize;
      // 顯示結果
      alert(`中奖 / You won: ${prize.text}`);
      // 若獎項是"One more spin chance"，額外增加一次
      if (prize.text === "One more spin chance") {
        chances++;
        document.getElementById('chances').innerText = chances + extraSpin;
        alert("獲得額外轉盤機會 / Extra spin gained!");
      }
      // 回傳通知（可用Telegram Bot API集成）
      sendPrizeMessage(prize.text);
    }
  };
  requestAnimationFrame(animate);
}

function sendPrizeMessage(message) {
  // 這裡可以用Telegram Bot API發送訊息到@pcd_luckywheel_bot
  // 需要你的bot token及chat_id
  fetch('https://api.telegram.org/bot 7779859704:AAHwAPPUhTQQRwVJ1FeGJUuY6BJ5vBmFths/sendMessage', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      chat_id: '@pcd_luckywheel_bot',
      text: `🎉 抽獎結果 / Result: ${message}`
    })
  });
}

// 事件監聽
document.getElementById('spinBtn').addEventListener('click', spin);

// 3天限制
function checkLastSpin() {
  const now = new Date();
  if (lastSpinDate) {
    const diff = (now - new Date(lastSpinDate)) / (1000*3600*24);
    if (diff < 3) {
      alert(`每3天只能抽一次 / You can only spin once every 3 days`);
      document.getElementById('spinBtn').disabled = true;
    } else {
      document.getElementById('spinBtn').disabled = false;
    }
  }
}
checkLastSpin();

// 紀錄最後轉動時間
function recordSpin() {
  lastSpinDate = new Date().toISOString();
  // 儲存到localStorage或後端
}

// 增加訂閱/分享獎勵
// 按鈕或事件來觸發額外轉盤機會
// 這裡示範
// 假設點擊後獲得一次額外機會
function subscribeShare() {
  chances++;
  document.getElementById('chances').innerText = chances + extraSpin;
  alert("獲得額外轉盤機會 / Extra spin from subscribe/share!");
}

</script>
</body>
</html>
