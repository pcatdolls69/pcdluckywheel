<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>幸运转盘 / Lucky Wheel</title>
<style>
  :root{
    --soft-pink:#ffe6f9;
    --soft-purple:#f3c8f0;
    --pink-text:#5a0060;
  }
  body{
    margin:0; color:#333;
    font-family:'Noto Sans SC', Arial, sans-serif;
    background:#222;
    display:flex; flex-direction:column; align-items:center; min-height:100vh;
  }
  h2{margin:18px 0 8px; color:#fff}
  #wheel-container{
    position:relative;
    width:420px; height:420px;
    overflow:visible;
    margin-top:6px;
  }
  canvas{
    width:100%; height:100%; border-radius:50%;
    box-shadow: 0 0 30px rgba(255,255,255,.85), 0 0 60px rgba(255,200,255,.6);
    background:#fff;
  }
  #centerPointer{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:2;}
  #centerPointer polygon{fill:#000}

  #spinBtn, .cta button{
    background:var(--soft-pink);
    border:2px solid var(--soft-purple);
    border-radius:16px;
    color:var(--pink-text);
    font-weight:700;
    box-shadow:0 3px 6px rgba(0,0,0,0.15);
    cursor:pointer;
  }
  #spinBtn{ margin-top:8px; padding:12px 28px; font-size:18px; position:relative; top:-18px; }
  #spinBtn:active{transform:scale(.98)}
  #status{margin-top:0; font-size:14px; color:#fff; position:relative; top:-14px;}

  .cta{ display:flex; gap:10px; margin-top:8px; justify-content:center; position:relative; top:-14px; }
  .cta button{ padding:10px 16px; }

  #cooldown{ margin-top:4px; font-size:13px; color:#cfc7ff; position:relative; top:-10px; }
  #footer{margin:6px 0 18px; text-align:center; font-size:13px; color:#fff}
  #footer a{color:#fff; font-weight:700; text-decoration:none}
</style>
</head>
<body>

<h2>幸运转盘 / Lucky Wheel</h2>

<div id="wheel-container">
  <canvas id="wheel" width="420" height="420"></canvas>

  <svg id="centerPointer" viewBox="0 0 420 420" aria-hidden="true">
    <polygon points="209,225 211,225 210,170"></polygon>
  </svg>
</div>

<button id="spinBtn">开始抽奖 / Start</button>
<div id="status">剩余次数 / Chances: <span id="chances">0</span></div>
<div id="cooldown" hidden></div>

<div class="cta">
  <button id="subBtn">🔗 订阅 / Subscribe（+1）</button>
  <button id="shareBtn">🔗 分享 / Share（+1）</button>
</div>

<div id="footer">
  ⚠️ 所有奖项不能重叠使用 / All prizes cannot be combined<br>
  <a href="https://t.me/pcatdolls" target="_blank">pcatdolls 频道 / Channel</a>
</div>

<script>
const isTG = !!(window.Telegram && Telegram.WebApp);
if (isTG) Telegram.WebApp.ready();

const prizes = [
  "45⏰ or 60⏰ / 10 OFF",
  "45⏰ or 60⏰ / 20 OFF",
  "One more spin chance",
  "45⏰ or 60⏰ / 10 OFF",
  "Sorry 😢",
  "45⏰ or 60⏰ / 20 OFF",
  "Sorry 😢",
  "45⏰ or 60⏰ / 40 OFF",
  "Sorry 😢"
];
const colors = ["#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8"];

const THREE_DAYS = 3 * 24 * 60 * 60 * 1000;
const LS_LAST = "pcdLastSpinAt";
const LS_BONUS = "pcdBonusSpins";

let lastSpinAt = parseInt(localStorage.getItem(LS_LAST) || "0", 10);
let bonusSpins = parseInt(localStorage.getItem(LS_BONUS) || "0", 10);

const chancesEl = document.getElementById('chances');
const spinBtn = document.getElementById('spinBtn');
const cooldownEl = document.getElementById('cooldown');

function baseSpinAvailable() { return Date.now() - lastSpinAt >= THREE_DAYS; }
function totalChances() { return (baseSpinAvailable() ? 1 : 0) + bonusSpins; }
function saveState() {
  localStorage.setItem(LS_LAST, String(lastSpinAt));
  localStorage.setItem(LS_BONUS, String(bonusSpins));
}
function fmtDuration(ms) {
  const s = Math.max(0, Math.floor(ms/1000));
  const d = Math.floor(s / 86400);
  const h = Math.floor((s % 86400) / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  const pad = n => String(n).padStart(2,'0');
  return (d>0? d+"d ":"") + pad(h)+":"+pad(m)+":"+pad(sec);
}
function updateUI() {
  chancesEl.textContent = String(totalChances());
  spinBtn.disabled = totalChances() <= 0;
  if (!baseSpinAvailable()) {
    cooldownEl.hidden = false;
    const remainMs = THREE_DAYS - (Date.now() - lastSpinAt);
    cooldownEl.textContent = "下次免费转盘倒计时 / Next free spin in: " + fmtDuration(remainMs);
  } else {
    cooldownEl.hidden = true;
  }
}
setInterval(updateUI, 1000);
updateUI();

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');

function drawWheel(angleOffset = 0) {
  const cx = 210, cy = 210, r = 200;
  const n = prizes.length;
  const arc = 2*Math.PI / n;
  ctx.clearRect(0,0,420,420);
  for (let i=0;i<n;i++){
    const start = i*arc + angleOffset;
    const end = start + arc;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,end);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + arc/2);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#000";
    ctx.font = "bold 20px Arial, 'Noto Sans SC', sans-serif";
    ctx.fillText(prizes[i], r-40, 0);
    ctx.restore();
  }
}
drawWheel();

spinBtn.addEventListener('click', () => {
  if (totalChances() <= 0) {
    const msg = "每 3 天 1 次。可通过订阅/分享获得 +1 次。/ No more chances. Subscribe or Share to get +1.";
    if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg); else alert(msg);
    return;
  }
  if (bonusSpins > 0) bonusSpins--; else lastSpinAt = Date.now();
  saveState(); updateUI();

  const spinAngle = 360*5 + Math.random()*360;
  const duration = 4200;
  const start = performance.now();

  function step(now){
    const p = Math.min((now-start)/duration, 1);
    const ease = 1 - Math.pow(1-p,3);
    drawWheel(ease * spinAngle * Math.PI/180);
    if (p < 1) requestAnimationFrame(step);
    else onDone(spinAngle);
  }
  requestAnimationFrame(step);
});

function onDone(spinAngleDeg){
  const n = prizes.length;
  const raw = (spinAngleDeg % 360) / 360;
  const idx = (n - 1 - Math.floor(raw * n)) % n;
  const result = prizes[idx];

  const msg = /Sorry/.test(result) ? "谢谢参与 / Thanks for playing" : "恭喜中奖 / Congratulations!\n" + result;
  if (isTG && Telegram.WebApp.showPopup) {
    Telegram.WebApp.showPopup({title:"幸运转盘 / Lucky Wheel", message:msg, buttons:[{type:'ok', id:'ok'}]});
  } else if (isTG && Telegram.WebApp.showAlert) {
    Telegram.WebApp.showAlert(msg);
  } else {
    alert(msg);
  }

  if (/One more spin chance/i.test(result)) { bonusSpins++; saveState(); updateUI(); }
  reportResult(result);
}

document.getElementById('subBtn').addEventListener('click', () => {
  if (isTG) Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
  bonusSpins++; saveState(); updateUI();
});
document.getElementById('shareBtn').addEventListener('click', () => {
  try{
    if (isTG && Telegram.WebApp.shareToStory) {
      Telegram.WebApp.shareToStory({text:'PCD Lucky Wheel', widget_link:'https://t.me/pcatdolls'});
    } else if (isTG) {
      Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
    } else {
      window.open('https://t.me/pcatdolls','_blank');
    }
  } finally {
    bonusSpins++; saveState(); updateUI();
  }
});

const BOT_TOKEN   = "";           // 可选直连：填入你的 token
const TARGET_CHAT_ID = "";        // 可选直连：@频道名 或 -100xxxxxxxxxx

function reportResult(result){
  try {
    if (isTG && Telegram.WebApp.sendData) {
      const u = Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user;
      const name = u ? ((u.first_name||'') + (u.last_name?(' '+u.last_name):'')) : 'Guest';
      const handle = u && u.username ? ('@'+u.username) : '';
      Telegram.WebApp.sendData(`Result=${result}; User=${name}${handle?' '+handle:''}`);
    }
  } catch(e){}

  if (BOT_TOKEN && TARGET_CHAT_ID) {
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: TARGET_CHAT_ID, text: `🎯 PCD Lucky Wheel\nResult: ${result}` })
    }).catch(()=>{});
  }
}
</script>
</body>
</html>
