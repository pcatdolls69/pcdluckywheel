<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>PCD Lucky Wheel</title>
<style>
  /* —— 页面白底 —— */
  body{
    margin:0; background:#fff; color:#333;
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:100vh; -webkit-tap-highlight-color:transparent; user-select:none;
  }
  h2{margin:10px 0 12px; text-align:center}
  .container{position:relative; display:flex; flex-direction:column; align-items:center}

  /* —— 固定尺寸画布（最稳妥，不会消失）—— */
  #wheelCanvas{
    width:360px; height:360px;            /* CSS 尺寸 */
    background:#fff; border-radius:50%;
    box-shadow:inset 0 0 0 10px rgba(107,35,157,.14), 0 6px 14px rgba(0,0,0,.08);
    display:block;
  }
  /* HTML 属性尺寸，避免变成 0×0 */
  /* <canvas id="wheelCanvas" width="360" height="360"></canvas> 会配合上面的 CSS */

  /* —— 深紫色三角指针固定 12 点 —— */
  .pointer{
    position:absolute; top:calc(50% - 200px); left:50%; transform:translateX(-50%);
    width:0; height:0; border-left:14px solid transparent; border-right:14px solid transparent;
    border-bottom:26px solid #5c1898; filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
    z-index:10;
  }

  /* —— 中央深紫圆心（装饰）—— */
  .hub{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:24%; aspect-ratio:1/1; border-radius:50%; background:#5c1898;
    box-shadow:0 2px 6px rgba(0,0,0,.18) inset, 0 0 0 10px #fff;
    z-index:2; pointer-events:none;
  }

  /* —— 按钮、次数、底部说明（底部才中英对照）—— */
  #spinBtn{
    margin-top:14px; padding:10px 18px; border:none; border-radius:10px;
    background:#f7d3e8; color:#4b0c7a; font-weight:800; font-size:16px; cursor:pointer;
  }
  #spinBtn:disabled{opacity:.6; cursor:not-allowed}
  #chances{margin-top:6px; font-size:14px}
  .links{margin-top:10px}
  .links a{color:#6b00c8; text-decoration:none; font-weight:700; margin:0 8px}
  .note{margin-top:10px; font-size:12px; color:#444; text-align:center; line-height:1.5}
</style>
</head>
<body>
  <h2>PCD Lucky Wheel<br><small>幸运转盘 · Lucky Draw</small></h2>

  <div class="container">
    <div class="pointer" aria-hidden="true"></div>
    <!-- ✅ 同时有 CSS 和 HTML 尺寸，保证不为 0 -->
    <canvas id="wheelCanvas" width="360" height="360"></canvas>
    <div class="hub" aria-hidden="true"></div>
  </div>

  <!-- 开始 / Start（转盘正下方，简体+英文） -->
  <button id="spinBtn">🎯 开始 / Start</button>
  <div id="chances">剩余次数 / Chances: --</div>

  <!-- 只有最下面双语 -->
  <div class="links">
    <a id="subLink" href="#">订阅 / Subscribe</a>·
    <a id="shareLink" href="#">分享 / Share</a>
  </div>
  <div class="note">
    ⚠️ 所有奖项不能重叠使用 · Prizes cannot be combined<br>
    订阅并分享频道可多一次机会 · Subscribe &amp; Share for +1 spin
  </div>

  <!-- 顺序很重要：先 GSAP，再 Winwheel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/winwheel@2.8.0/Winwheel.min.js"></script>

  <script>
  (function(){
    /* ===== 配色（粉、紫、蓝、黄，对比清楚） ===== */
    const COLORS = ['#ffd1e8','#cbb2fe','#b6e1ff','#ffe07a'];

    const SEGMENTS = [
      { fillStyle: COLORS[0], text: '45⏰ or 60⏰/ 10 off' },
      { fillStyle: COLORS[1], text: '45⏰ or 60⏰/ 20 off' },
      { fillStyle: COLORS[2], text: 'One more spin chance' },
      { fillStyle: COLORS[3], text: '45⏰ or 60⏰/ 10 off' },
      { fillStyle: COLORS[0], text: 'Sorry 😢' },
      { fillStyle: COLORS[1], text: '45⏰ or 60⏰/ 20 off' },
      { fillStyle: COLORS[2], text: 'Sorry 😢' },
      { fillStyle: COLORS[3], text: '45⏰ or 60⏰/ 40 off' },
      { fillStyle: COLORS[0], text: 'Sorry 😢' }
    ];

    /* ===== Telegram 就绪 ===== */
    const isTG = !!(window.Telegram && Telegram.WebApp);
    if (isTG) { Telegram.WebApp.ready(); }

    /* ===== 身份 & 3天一次限制（外加 bonus） ===== */
    const TG_USER = (isTG && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) || null;
    const USER_ID = TG_USER ? String(TG_USER.id) : 'guest';
    const KEY = 'pcd_wheel_' + USER_ID; // { lastBaseSpinISO, bonus }
    function readState(){ try{ return JSON.parse(localStorage.getItem(KEY)) || {lastBaseSpinISO:null, bonus:0}; }catch(e){ return {lastBaseSpinISO:null, bonus:0}; } }
    function writeState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
    function baseAvailable(now=new Date()){ const s=readState(); if(!s.lastBaseSpinISO) return true; return (now - new Date(s.lastBaseSpinISO)) >= 3*24*60*60*1000; }
    function totalChances(){ const s=readState(); return (baseAvailable()?1:0) + (s.bonus|0); }
    function consume(){ const s=readState(); if(s.bonus>0) s.bonus--; else s.lastBaseSpinISO=new Date().toISOString(); writeState(s); }
    function addBonus(n=1){ const s=readState(); s.bonus=(s.bonus|0)+n; writeState(s); }

    /* ===== 订阅/分享：各 +1 次 ===== */
    document.getElementById('subLink').onclick = (e)=>{
      e.preventDefault();
      if(isTG) Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
      addBonus(1); refresh();
    };
    document.getElementById('shareLink').onclick = (e)=>{
      e.preventDefault();
      try{
        if(isTG && Telegram.WebApp.shareToStory){
          Telegram.WebApp.shareToStory({text:'PCD Lucky Wheel', widget_link:'https://t.me/pcatdolls'});
        }else if(isTG){
          Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
        }
      } finally {
        addBonus(1); refresh();
      }
    };

    /* ===== 转盘（固定 360 画布，外半径 168，确保可见） ===== */
    const canvas = document.getElementById('wheelCanvas'); // 360×360
    let wheel = null;

    function buildWheel(){
      wheel = new Winwheel({
        canvasId: 'wheelCanvas',
        numSegments: SEGMENTS.length,
        outerRadius: 168,                 // 360/2 - 留出外圈描边
        textFontSize: 14,
        textFillStyle: '#333',
        segments: SEGMENTS,
        animation:{
          type:'spinToStop',
          duration:5,
          spins:8,
          callbackFinished:onDone
        }
      });
    }

    /* ===== UI ===== */
    const btn = document.getElementById('spinBtn');
    const chancesEl = document.getElementById('chances');
    function refresh(){
      const t = totalChances();
      chancesEl.textContent = '剩余次数 / Chances: ' + t;
      btn.disabled = t <= 0;
    }

    btn.onclick = ()=>{
      if (totalChances() <= 0) {
        const msg = '每人 3 天可转 1 次；订阅/分享或抽到「One more spin chance」可 +1 次。\nOne spin every 3 days. Subscribe/Share or landing on bonus tile gives +1 chance.';
        if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg); else alert(msg);
        return;
      }
      consume(); refresh();
      btn.textContent = '🎰 旋转中 / Spinning…'; btn.disabled = true;
      wheel.startAnimation();
      setTimeout(()=>{ btn.textContent='🎯 开始 / Start'; refresh(); }, 5200);
    };

    /* ===== 结果处理 ===== */
    function onDone(seg){
      const text = seg?.text || '';
      if (/One more spin chance/i.test(text)){ addBonus(1); refresh(); notify('获得 +1 次机会 · +1 extra chance'); }
      else if (/Sorry/i.test(text)) { notify('谢谢参与 · Thanks for playing'); }
      else { notify('恭喜中奖：'+text+'\nCongratulations!'); }

      // 回传给 @pcd_luckywheel_bot（姓名 + 结果）
      const u = TG_USER;
      const name = u ? ((u.first_name||'') + (u.last_name?(' '+u.last_name):'')) : 'Guest';
      const handle = u && u.username ? ('@'+u.username) : '';
      const payload = `Winner: ${name}${handle?' '+handle:''} | Result: ${text}`;
      if (isTG && Telegram.WebApp.sendData) { try{ Telegram.WebApp.sendData(payload); }catch(e){} }

      try{ if(isTG && Telegram.WebApp.HapticFeedback){ Telegram.WebApp.HapticFeedback.notificationOccurred('success'); } }catch(e){}
    }

    function notify(message){
      if (isTG && Telegram.WebApp.showPopup) Telegram.WebApp.showPopup({title:'PCD Lucky Wheel', message, buttons:[{type:'ok', id:'ok'}]});
      else if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(message);
      else alert(message);
    }

    /* ===== 初始化（等 window.onload，100% 不丢画布） ===== */
    window.addEventListener('load', function(){
      buildWheel();
      refresh();
    });
  })();
  </script>
</body>
</html>
