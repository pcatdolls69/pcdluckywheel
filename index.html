<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCD Lucky Wheel</title>
<style>
Â Â :root{
Â Â Â Â --bg:#f6f0f8; --card:#fff; --text:#3b3b3b; --muted:#8a8a8a;
Â Â Â Â --accent:#7a2c87; --accent2:#d6b3df; --shadow:0 10px 30px rgba(0,0,0,.08);
Â Â }
Â Â html,body{height:100%}
Â Â body{
Â Â Â Â margin:0; background:var(--bg);
Â Â Â Â display:flex; align-items:center; justify-content:center; min-height:100vh;
Â Â Â Â font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, PingFang SC, "Noto Sans CJK TC",
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "Hiragino Sans GB", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
Â Â Â Â color:var(--text);
Â Â }
Â Â .card{
Â Â Â Â width:min(960px,92vw); background:var(--card); border-radius:28px; padding:24px 18px;
Â Â Â Â box-shadow:var(--shadow)
Â Â }
Â Â .stage{position:relative; background:#faf6fd; border-radius:24px; aspect-ratio:1/1; width:100%; max-width:720px; margin:0 auto; 
Â Â Â Â Â Â Â Â Â border:1px solid #efe7f5; box-shadow: inset 0 0 0 8px #efe7f5}
Â Â canvas{width:100%; height:100%; display:block; border-radius:16px}
Â Â .center-pointer{
Â Â Â Â position:absolute; inset:auto 0 50% 0; margin:auto; translate:0 50%;
Â Â Â Â width:92px; height:92px; border-radius:50%;
Â Â Â Â background:radial-gradient(circle at 50% 45%, #fff 0 28px, var(--accent) 28px 46px, #fff0 47px);
Â Â Â Â box-shadow:var(--shadow)
Â Â }
Â Â .actions{display:flex; justify-content:center; margin:18px 0 10px}
Â Â .btn{
Â Â Â Â min-width:280px; height:64px; padding:0 28px; border:0; border-radius:20px; cursor:pointer;
Â Â Â Â background:linear-gradient(135deg,#ff9fd2 0%,#f0b9ff 100%);
Â Â Â Â color:#632d79; font-weight:800; font-size:22px; box-shadow:var(--shadow)
Â Â }
Â Â .btn:disabled{opacity:.6; cursor:not-allowed}

Â Â .chipRow{display:flex; gap:14px; justify-content:center; margin:8px 0 10px}
Â Â .chip{
Â Â Â Â display:flex; align-items:center; gap:10px; border-radius:16px; padding:12px 16px;
Â Â Â Â background:#fff; box-shadow:var(--shadow); color:#3b3b3b; font-weight:600;
Â Â }
Â Â .chip .dot{font-size:20px}
Â Â .muted{color:var(--muted); text-align:center; font-size:14px; line-height:1.6}
Â Â .rule{margin-top:6px}
Â Â .status{margin-top:8px}
Â Â #remaining{ text-align:center; color:#8660c6; font-size:14px; margin-top:8px; }
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
Â Â <div class="card">
Â Â Â Â <div class="stage">
Â Â Â Â Â Â <canvas id="wheel"></canvas>
Â Â Â Â Â Â <div class="center-pointer" aria-hidden="true"></div>
Â Â Â Â </div>

Â Â Â Â <div class="actions">
Â Â Â Â Â Â <button id="startBtn" class="btn">é–‹å§‹ / Start</button>
Â Â Â Â </div>

Â Â Â Â <!-- å‰©é¤˜æ¬¡æ•¸ -->
Â Â Â Â <div id="remaining" aria-live="polite"></div>

Â Â Â Â <div class="chipRow">
Â Â Â Â Â Â <button id="subBtn" class="chip"><span class="dot">âœ…</span> è¨‚é–± PCD / Subscribe PCD</button>
Â Â Â Â Â Â <button id="shareBtn" class="chip"><span class="dot">ğŸ”—</span> åˆ†äº« / Share</button>
Â Â Â Â </div>

Â Â Â Â <div class="muted rule">
Â Â Â Â Â Â ğŸŒŸ æ¯äººæ¯å‘¨ 1 æ¬¡ï¼›å®Œæˆ è¨‚é–± + åˆ†äº« å† +1 æ¬¡<br/>
Â Â Â Â Â Â (Weekly 1 spin; +1 bonus after subscribing + sharing)
Â Â Â Â </div>
Â Â Â Â <div id="status" class="muted status"></div>
Â Â </div>

<script>
/* ===== Telegram Mini App boot ===== */
const TG = window.Telegram?.WebApp;
if (TG) TG.expand();

/* ===== é…ç½®ï¼šçå“ / é¡è‰² ===== */
const prizes = [
Â Â "1 ğŸ˜¢ sorry",
Â Â "45ğŸ’ or 60ğŸ’ / 10 off",
Â Â "3 ğŸ˜¢ sorry",
Â Â "45ğŸ’ or 60ğŸ’ / 20 off",
Â Â "8 ğŸ˜¢ sorry",
Â Â "45ğŸ’ or 60ğŸ’ / 40 off",
Â Â "5 ğŸ˜¢ sorry",
Â Â "45ğŸ’ or 60ğŸ’ / 10 off"
];
const segColors = ["#fcde","rgba(255,218,237,.9)","#cff","rgba(255,218,237,.9)","#ffe0","#ffd7","#e8e3ff","#ffd7"];
const n = prizes.length;

/* ===== ç•«å¸ƒå°ºå¯¸ ===== */
const wheel = document.getElementById('wheel');
const ctxÂ Â Â = wheel.getContext('2d');
const DPRÂ Â Â = Math.max(2, window.devicePixelRatio || 1);
const sizeÂ Â = 640; 
wheel.widthÂ Â = size * DPR;
wheel.height = size * DPR;
const W = wheel.width, H = wheel.height, R = Math.min(W, H)/2 * 0.82;
const CX = W/2, CY = H/2;
const segmentAngle = 2*Math.PI / n;
let currentRotation = 0; // radians

/* ===== æ¯é€±é¡åº¦ & ç‹€æ…‹ ===== */
const STORE_KEY = "pcd_wheel_state";
const WEEK_KEYÂ Â = (() => {
Â Â const now = new Date();
Â Â const first = new Date(now.getFullYear(), 0, 1);
Â Â const week = Math.floor((now - first)/(7*24*3600*1000));
Â Â return `${now.getFullYear()}-${week}`;
})();
function loadState(){
Â Â const raw = localStorage.getItem(STORE_KEY);
Â Â let s = {};
Â Â try{ s = JSON.parse(raw)||{} }catch(_){}
Â Â if (s.week !== WEEK_KEY) s = {week:WEEK_KEY, used:0, subscribed:false, shared:false};
Â Â return s;
}
function saveState(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
let state = loadState();

/* æ¯é€±é…é¡ï¼š1 æ¬¡ï¼›è‹¥åŒæ™‚ subscribed+shared â†’ +1 */
function getAllowance(){
Â Â return 1 + (state.subscribed && state.shared ? 1 : 0);
}
function getRemaining(){ return Math.max(0, getAllowance() - (state.used||0)); }

function updateStatus(){
Â Â const allow = getAllowance();
Â Â const usedÂ Â = state.used||0;
Â Â const subÂ Â Â = state.subscribed ? "âœ…" : "âŒ";
Â Â const shÂ Â Â Â = state.sharedÂ Â Â Â Â ? "âœ…" : "âŒ";
Â Â const el = document.getElementById('status');
Â Â el.innerHTML =
Â Â Â Â `æœ¬é€±å¯ç”¨ï¼š${allow} æ¬¡ï¼ˆå·²ç”¨ ${used}ï¼‰ãƒ»è¨‚é–±/åˆ†äº«ï¼š${sub}/${sh}`;
}
function updateRemainingDisplay(){
Â Â const el = document.getElementById('remaining');
Â Â if (!el) return;
Â Â el.textContent = `å‰©é¤˜æ¬¡æ•¸ï¼š${getRemaining()}`
}

/* ===== ç•«è¼ªç›¤ ===== */
function drawWheel(){
Â Â ctx.clearRect(0,0,W,H);
Â Â ctx.save();
Â Â ctx.translate(CX, CY);
Â Â ctx.rotate(currentRotation);

Â Â // ä½¿ 12 é»é˜æ–¹å‘ç‚º 0 åº¦ï¼ˆä¸Šæ–¹æŒ‡é‡ï¼‰
Â Â ctx.rotate(-Math.PI/2);

Â Â for(let i=0;i<n;i++){
Â Â Â Â ctx.beginPath();
Â Â Â Â ctx.moveTo(0,0);
Â Â Â Â ctx.fillStyle = segColors[i % segColors.length];
Â Â Â Â ctx.arc(0,0,R, i*segmentAngle, (i+1)*segmentAngle);
Â Â Â Â ctx.closePath(); ctx.fill();

Â Â Â Â // æ–‡å­—
Â Â Â Â ctx.save();
Â Â Â Â ctx.rotate(i*segmentAngle + segmentAngle/2);
Â Â Â Â ctx.textAlign = "center";
Â Â Â Â ctx.fillStyle = "#2b2b2b";
Â Â Â Â ctx.font = `${22*DPR}px Arial`;
Â Â Â Â ctx.translate(R*0.68, 0);
Â Â Â Â ctx.rotate(Math.PI/2);
Â Â Â Â wrapText(prizes[i], -120, -10, 240, 28);
Â Â Â Â ctx.restore();
Â Â }
Â Â ctx.restore();
}

// å¤šè¡Œæ–·å­—
function wrapText(txt, x, y, maxWidth, lineHeight){
Â Â const words = (""+txt).split(" ");
Â Â let line = "", yy = y;
Â Â for(let i=0;i<words.length;i++){
Â Â Â Â const test = line + (line? " ":"") + words[i];
Â Â Â Â const w = ctx.measureText(test).width;
Â Â Â Â if (w < maxWidth){
Â Â Â Â Â Â line = test;
Â Â Â Â }else{
Â Â Â Â Â Â ctx.fillText(line, x, yy);
Â Â Â Â Â Â line = words[i];
Â Â Â Â Â Â yy += lineHeight;
Â Â Â Â }
Â Â }
Â Â ctx.fillText(line, x, yy);
}

/* ===== æ—‹è½‰é‚è¼¯ ===== */
let spinning = false;
function spin(){
Â Â if (spinning) return;
Â Â if (getRemaining()<=0){ alert("æœ¬å‘¨å·²ç”¨å®Œ / Weekly allowance used up"); return; }
Â Â spinning = true;
Â Â startBtn.disabled = true;

Â Â const targetIndex = Math.floor(Math.random()*n);
Â Â const targetAngle = -Math.PI/2 - (targetIndex*segmentAngle + segmentAngle/2);
Â Â const extra = (Math.PI*2) * 6;Â Â Â Â Â Â Â Â Â // å¤šè½‰å¹¾åœˆ
Â Â const finalRot = normalize(currentRotation) + extra + shortestDelta(currentRotation, targetAngle);
Â Â const start = performance.now();
Â Â const D = 4200;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // å‹•ç•«æ¯«ç§’

Â Â (function animate(t0){
Â Â Â Â const p = Math.min(1,(t0-start)/D);
Â Â Â Â const ease = 1 - Math.pow(1-p,3);
Â Â Â Â const rot = currentRotation + (finalRot-currentRotation)*ease;
Â Â Â Â currentRotation = rot;
Â Â Â Â drawWheel();

Â Â Â Â if(p<1){ requestAnimationFrame(animate); }
Â Â Â Â else{
Â Â Â Â Â Â currentRotation = normalize(finalRot);
Â Â Â Â Â Â drawWheel();

Â Â Â Â Â Â const idx = getIndexByRotation(currentRotation);
Â Â Â Â Â Â finish(prizes[idx], idx);
Â Â Â Â }
Â Â })(start);
}

function shortestDelta(from, to){
Â Â let d = to - (from % (2*Math.PI));
Â Â if(d >Â Â Math.PI) d -= 2*Math.PI;
Â Â if(d < -Math.PI) d += 2*Math.PI;
Â Â return d;
}
function normalize(a){
Â Â a = a % (2*Math.PI);
Â Â if (a<0) a += 2*Math.PI;
Â Â return a;
}
function getIndexByRotation(rot){
Â Â const a = normalize(rot);
Â Â const topAngle = 0; // æŒ‡é‡åœ¨ 12 é»é˜æ–¹å‘
Â Â // è½‰æˆä»¥ 12 é»é˜ç‚º 0 çš„è§’åº¦
Â Â const angFromTop = normalize(topAngle - a);
Â Â const index = Math.floor( angFromTop / segmentAngle );
Â Â return (index + n) % n;
}

/* ===== å®Œæˆä¸€æŠ½ ===== */
function finish(text, index){
Â Â state.used = (state.used||0) + 1;
Â Â saveState(state);
Â Â updateStatus();
Â Â updateRemainingDisplay();

Â Â alert("ğŸ‰ æ­å–œä¸­çï¼/ ğŸ‰ Congratulations!\n\n" + prizes[index]);

Â Â // å›å‚³çµ¦ Telegram bot
Â Â if (TG){
Â Â Â Â const payload = {
Â Â Â Â Â Â type: "spin_result",
Â Â Â Â Â Â result: prizes[index],
Â Â Â Â Â Â index,
Â Â Â Â Â Â used: state.used,
Â Â Â Â Â Â allowance: getAllowance(),
Â Â Â Â Â Â subscribed: state.subscribed,
Â Â Â Â Â Â shared: state.shared
Â Â Â Â };
Â Â Â Â try{ TG.sendData(JSON.stringify(payload)); }catch(_){}
Â Â }

Â Â startBtn.disabled = getRemaining()<=0;
Â Â spinning = false;
}

/* ===== UI ç¶å®š ===== */
const startBtn = document.getElementById('startBtn');
const subBtnÂ Â Â = document.getElementById('subBtn');
const shareBtn = document.getElementById('shareBtn');

startBtn.addEventListener('click', spin);

subBtn.addEventListener('click', () => {
Â Â // ä½ çš„é »é“
Â Â window.open('https://t.me/pcatdolls', '_blank');
Â Â state.subscribed = true; saveState(state); updateStatus(); updateRemainingDisplay();
Â Â startBtn.disabled = getRemaining()<=0;
});

shareBtn.addEventListener('click', async () => {
Â Â const shareData = {
Â Â Â Â title: 'PCD Lucky Wheel',
Â Â Â Â text:Â Â 'ä¾†æŠ½çï¼Try your luck!',
Â Â Â Â url:Â Â Â location.href
Â Â };
Â Â try{
Â Â Â Â if(navigator.share){ await navigator.share(shareData); }
Â Â Â Â else{
Â Â Â Â Â Â window.open('https://t.me/share/url?url='+
Â Â Â Â Â Â Â Â encodeURIComponent(location.href)+'&text='+encodeURIComponent('ğŸ¡PCDæŠ½çè½‰ç›¤'), '_blank');
Â Â Â Â }
Â Â Â Â state.shared = true; saveState(state); updateStatus(); updateRemainingDisplay();
Â Â Â Â startBtn.disabled = getRemaining()<=0;
Â Â }catch(e){ /* user cancelled */ }
});

/* ===== åˆå§‹åŒ– ===== */
drawWheel();
updateStatus();
updateRemainingDisplay();
startBtn.disabled = getRemaining()<=0;
window.addEventListener('resize', () => {
Â Â // demo ç°¡åŒ–ï¼šä¿æŒå›ºå®šå°ºå¯¸ï¼Œå¿½ç•¥ resize é‡ç®—
});
</script>
</body>
</html>
