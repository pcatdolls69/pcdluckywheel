<!DOCTYPE html>
<html lang="zh-Hans">
<head>
Â Â <meta charset="UTF-8" />
Â Â <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
Â Â <title>PCD Lucky Wheel</title>
Â Â <style>
Â Â Â Â :root{
Â Â Â Â Â Â --pink:#ffd1e8; --purple:#cbb2fe; --blue:#b6e1ff; --yellow:#ffe07a;
Â Â Â Â Â Â --brand:#6b239d;Â Â Â Â Â Â Â Â Â Â Â Â /* æ·±ç´«ï¼ˆæŒ‡é’ˆ/é‡ç‚¹ï¼‰ */
Â Â Â Â Â Â --btn:#fcd5eb;Â Â Â Â Â Â Â Â Â Â Â Â Â Â /* ä½ é¸çš„æ·¡ç²‰è‰² */
Â Â Â Â Â Â --line:#e6e6e6;

Â Â Â Â Â Â --s-top: env(safe-area-inset-top, 0px);
Â Â Â Â Â Â --s-right: env(safe-area-inset-right, 0px);
Â Â Â Â Â Â --s-bottom: env(safe-area-inset-bottom, 0px);
Â Â Â Â Â Â --s-left: env(safe-area-inset-left, 0px);
Â Â Â Â }
Â Â Â Â *{box-sizing:border-box}
Â Â Â Â html,body{height:100%}
Â Â Â Â body{
Â Â Â Â Â Â margin:0; padding:16px; padding-bottom:calc(16px + var(--s-bottom));
Â Â Â Â Â Â background:#fff; /* âœ… å…¨é ç™½åº• */
Â Â Â Â Â Â font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif;
Â Â Â Â Â Â color:#222; -webkit-tap-highlight-color:transparent; user-select:none;
Â Â Â Â Â Â display:flex; align-items:center; justify-content:center;
Â Â Â Â }
Â Â Â Â .card{
Â Â Â Â Â Â width:min(440px,96vw);
Â Â Â Â Â Â background:#fff; border:1px solid var(--line); border-radius:16px;
Â Â Â Â Â Â box-shadow:0 10px 30px rgba(0,0,0,.04);
Â Â Â Â Â Â padding:16px; display:flex; flex-direction:column; align-items:center; gap:12px;
Â Â Â Â }
Â Â Â Â .title{font-weight:800; color:#1a1a1a; text-align:center}
Â Â Â Â .muted{opacity:.8; font-size:12px}
Â Â Â Â #wheelWrap{position:relative}
Â Â Â Â #wheelCanvas{display:block; background:#fff; border-radius:50%; box-shadow:0 6px 18px rgba(0,0,0,.08)}
Â Â Â Â /* âœ… æ·±ç´«è‰²æŒ‡é’ˆå›ºå®š 12 ç‚¹ */
Â Â Â Â .pointer{
Â Â Â Â Â Â position:absolute; top:-8px; left:50%; transform:translateX(-50%);
Â Â Â Â Â Â width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent; border-bottom:22px solid var(--brand);
Â Â Â Â Â Â filter:drop-shadow(0 2px 2px rgba(0,0,0,.2));
Â Â Â Â }
Â Â Â Â .row{display:flex; align-items:center; gap:10px}
Â Â Â Â /* âœ… æŒ‰éˆ•ç²‰è‰²ã€ç½®æ–¼è½‰ç›¤æ­£ä¸‹æ–¹ */
Â Â Â Â #spinBtn{
Â Â Â Â Â Â appearance:none; border:1px solid var(--line); cursor:pointer;
Â Â Â Â Â Â border-radius:12px; padding:10px 16px; font-weight:800;
Â Â Â Â Â Â background:var(--btn); color:#3b2156; font-size:16px; letter-spacing:.2px;
Â Â Â Â }
Â Â Â Â #spinBtn:disabled{opacity:.55; cursor:not-allowed}
Â Â Â Â .pill{
Â Â Â Â Â Â padding:8px 12px; border-radius:999px; background:#fafafa; border:1px solid var(--line); font-size:14px;
Â Â Â Â Â Â color:#333;
Â Â Â Â }
Â Â Â Â .tip{min-height:38px; text-align:center; font-size:14px}
Â Â Â Â .note{width:100%; font-size:12px; color:#444; text-align:center; line-height:1.4}
Â Â Â Â .sub{
Â Â Â Â Â Â display:inline-block; padding:8px 14px; border-radius:999px; border:1px solid var(--line);
Â Â Â Â Â Â background:#fff; text-decoration:none; color:#4b0082; font-weight:700;
Â Â Â Â }
Â Â </style>
</head>
<body>
Â Â <div class="card">
Â Â Â Â <div class="title">
Â Â Â Â Â Â PCD Lucky Wheel<br><span class="muted">å¹¸è¿è½¬ç›˜ Â· Lucky Draw</span>
Â Â Â Â </div>

Â Â Â Â <div id="wheelWrap">
Â Â Â Â Â Â <div class="pointer" aria-hidden="true"></div>
Â Â Â Â Â Â <canvas id="wheelCanvas"></canvas>
Â Â Â Â </div>

Â Â Â Â <div class="row" aria-live="polite">
Â Â Â Â Â Â <button id="spinBtn">ğŸ¯ Start / å¼€å§‹</button>
Â Â Â Â Â Â <div id="chance" class="pill">å‰©ä½™æ¬¡æ•° / Chances: --</div>
Â Â Â Â </div>

Â Â Â Â <div id="tip" class="tip">æ¯äºº 3 å¤©å¯è½¬ 1 æ¬¡ Â· One spin every 3 days</div>

Â Â Â Â <a id="subLink" class="sub" href="#" role="link">Subscribe / è®¢é˜…</a>

Â Â Â Â <div class="note">
Â Â Â Â Â Â âš ï¸ æ‰€æœ‰å¥–é¡¹ä¸èƒ½é‡å ä½¿ç”¨ Â· Prizes cannot be combined
Â Â Â Â </div>
Â Â </div>

Â Â <!-- Winwheel & TweenMaxï¼ˆ1.x ç‰ˆç¢ºä¿å…¼å®¹ï¼‰ -->
Â Â <script src="https://cdn.jsdelivr.net/npm/winwheel@2.8.0/Winwheel.min.js"></script>
Â Â <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>

Â Â <script>
Â Â (function(){
Â Â Â Â // ===== Telegram åˆå§‹åŒ–èˆ‡è¨‚é–±è·³è½‰ =====
Â Â Â Â const isTG = !!(window.Telegram && Telegram.WebApp);
Â Â Â Â if(isTG){
Â Â Â Â Â Â Telegram.WebApp.ready();
Â Â Â Â Â Â Telegram.WebApp.expand && Telegram.WebApp.expand();
Â Â Â Â Â Â document.getElementById('subLink').addEventListener('click', function(e){
Â Â Â Â Â Â Â Â e.preventDefault();
Â Â Â Â Â Â Â Â Telegram.WebApp.openTelegramLink("https://t.me/pcatdolls");
Â Â Â Â Â Â });
Â Â Â Â }else{
Â Â Â Â Â Â document.getElementById('subLink').setAttribute('href','https://t.me/pcatdolls');
Â Â Â Â }

Â Â Â Â // ===== ç²¾æº–å°ºå¯¸ + é«˜ DPI è‡ªé©æ‡‰ =====
Â Â Â Â const canvas = document.getElementById('wheelCanvas');
Â Â Â Â const ctx = canvas.getContext('2d');
Â Â Â Â const card = document.querySelector('.card');
Â Â Â Â const wheelWrap = document.getElementById('wheelWrap');
Â Â Â Â const titleEl = document.querySelector('.title');
Â Â Â Â const rowEl = document.querySelector('.row') || document.querySelector('div[aria-live]');
Â Â Â Â const tipEl = document.getElementById('tip');
Â Â Â Â const subEl = document.getElementById('subLink');
Â Â Â Â const noteEl = document.querySelector('.note');
Â Â Â Â const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));

Â Â Â Â function getViewportHeight(){
Â Â Â Â Â Â if (window.Telegram && Telegram.WebApp && (Telegram.WebApp.viewportStableHeight || Telegram.WebApp.viewportHeight)){
Â Â Â Â Â Â Â Â return Math.round(Telegram.WebApp.viewportStableHeight || Telegram.WebApp.viewportHeight);
Â Â Â Â Â Â }
Â Â Â Â Â Â return window.innerHeight;
Â Â Â Â }
Â Â Â Â function measure(el){ return el ? el.getBoundingClientRect().height : 0; }
Â Â Â Â function cssPx(n){ return Math.max(0, Math.floor(n)); }

Â Â Â Â function layoutWheel(){
Â Â Â Â Â Â const vh = getViewportHeight();
Â Â Â Â Â Â const bodyStyle = getComputedStyle(document.body);
Â Â Â Â Â Â const bodyPadV = parseFloat(bodyStyle.paddingTop) + parseFloat(bodyStyle.paddingBottom);

Â Â Â Â Â Â const cardStyle = getComputedStyle(card);
Â Â Â Â Â Â const padV = parseFloat(cardStyle.paddingTop) + parseFloat(cardStyle.paddingBottom);

Â Â Â Â Â Â const hTitle = measure(titleEl);
Â Â Â Â Â Â const hRowÂ Â Â = measure(rowEl);
Â Â Â Â Â Â const hTipÂ Â Â = measure(tipEl);
Â Â Â Â Â Â const hSubÂ Â Â = measure(subEl);
Â Â Â Â Â Â const hNoteÂ Â = measure(noteEl);
Â Â Â Â Â Â const gapsÂ Â Â = 12 * 4;

Â Â Â Â Â Â const maxCardH = vh - bodyPadV - 8;
Â Â Â Â Â Â const otherHeights = padV + hTitle + hRow + hTip + hSub + hNote + gaps;

Â Â Â Â Â Â const cardW = card.getBoundingClientRect().width;
Â Â Â Â Â Â const maxByHeight = Math.max(220, maxCardH - otherHeights);
Â Â Â Â Â Â const maxByWidthÂ Â = Math.max(220, cardW - 8*2);
Â Â Â Â Â Â const ideal = Math.min(maxByHeight, maxByWidth);

Â Â Â Â Â Â const CSS_SIZE = cssPx(Math.max(240, Math.min(ideal, 420))); // 240â€“420px

Â Â Â Â Â Â canvas.style.widthÂ Â = CSS_SIZE + 'px';
Â Â Â Â Â Â canvas.style.height = CSS_SIZE + 'px';
Â Â Â Â Â Â canvas.widthÂ Â = CSS_SIZE * DPR;
Â Â Â Â Â Â canvas.height = CSS_SIZE * DPR;
Â Â Â Â Â Â ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

Â Â Â Â Â Â if (window.__pcdWheel) {
Â Â Â Â Â Â Â Â window.__pcdWheel.outerRadius = (CSS_SIZE / 2) - 2;
Â Â Â Â Â Â Â Â window.__pcdWheel.draw(false);
Â Â Â Â Â Â }

Â Â Â Â Â Â const pointer = wheelWrap.querySelector('.pointer');
Â Â Â Â Â Â if (pointer){ pointer.style.top = '-8px'; } // å›ºå®š 12 é»
Â Â Â Â }

Â Â Â Â // ===== ä½¿ç”¨è€…èº«ä»½ + æ¬¡æ•¸é™åˆ¶ï¼ˆ3 å¤©ä¸€æ¬¡ï¼Œbonus å¯ç–ŠåŠ ï¼‰=====
Â Â Â Â const userObj = (isTG && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) || null;
Â Â Â Â const userId = userObj ? String(userObj.id) : 'guest';
Â Â Â Â const userName = userObj ? ((userObj.first_name || '') + (userObj.last_name ? (' ' + userObj.last_name) : '')) : 'Guest';
Â Â Â Â const userHandle = userObj && userObj.username ? ('@' + userObj.username) : '';
Â Â Â Â const STORAGE_KEY = 'pcd_wheel_' + userId;

Â Â Â Â function readState(){
Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â const raw = localStorage.getItem(STORAGE_KEY);
Â Â Â Â Â Â Â Â if(!raw) return { lastBaseSpinISO: null, bonus: 0 };
Â Â Â Â Â Â Â Â const obj = JSON.parse(raw);
Â Â Â Â Â Â Â Â return { lastBaseSpinISO: obj.lastBaseSpinISO || null, bonus: obj.bonus|0 };
Â Â Â Â Â Â } catch(e){
Â Â Â Â Â Â Â Â return { lastBaseSpinISO: null, bonus: 0 };
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â function writeState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
Â Â Â Â function baseAvailable(now = new Date()){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â if(!st.lastBaseSpinISO) return true;
Â Â Â Â Â Â const diff = now - new Date(st.lastBaseSpinISO);
Â Â Â Â Â Â return diff >= 3*24*60*60*1000; // 3 å¤©
Â Â Â Â }
Â Â Â Â function totalChances(){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â return (baseAvailable()?1:0) + (st.bonus|0);
Â Â Â Â }
Â Â Â Â function consumeChance(){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â if(st.bonus > 0){ st.bonus -= 1; }
Â Â Â Â Â Â else { st.lastBaseSpinISO = new Date().toISOString(); }
Â Â Â Â Â Â writeState(st);
Â Â Â Â }
Â Â Â Â function addBonus(n=1){
Â Â Â Â Â Â const st = readState();
Â Â Â Â Â Â st.bonus = (st.bonus|0) + n;
Â Â Â Â Â Â writeState(st);
Â Â Â Â }

Â Â Â Â // ===== UI =====
Â Â Â Â const $btn = document.getElementById('spinBtn');
Â Â Â Â const $chance = document.getElementById('chance');
Â Â Â Â const $tip = document.getElementById('tip');
Â Â Â Â function toast(msg){ $tip.textContent = msg; }
Â Â Â Â function updateChances(){
Â Â Â Â Â Â $chance.textContent = 'å‰©ä½™æ¬¡æ•° / Chances: ' + totalChances();
Â Â Â Â Â Â $btn.disabled = totalChances() <= 0;
Â Â Â Â }

Â Â Â Â // ===== çé …ï¼ˆ9 é …ï¼Œç²‰/ç´«/è—/é»ƒï¼‰=====
Â Â Â Â const segs = [
Â Â Â Â Â Â { fillStyle:'#ffd1e8', text:'45â° or 60â°/ 10 off' },
Â Â Â Â Â Â { fillStyle:'#cbb2fe', text:'45â° or 60â°/ 20 off' },
Â Â Â Â Â Â { fillStyle:'#b6e1ff', text:'One more spin chance' },
Â Â Â Â Â Â { fillStyle:'#ffe07a', text:'45â° or 60â°/ 10 off' },
Â Â Â Â Â Â { fillStyle:'#ffd1e8', text:'Sorry ğŸ˜¢' },
Â Â Â Â Â Â { fillStyle:'#cbb2fe', text:'45â° or 60â°/ 20 off' },
Â Â Â Â Â Â { fillStyle:'#b6e1ff', text:'Sorry ğŸ˜¢' },
Â Â Â Â Â Â { fillStyle:'#ffe07a', text:'45â° or 60â°/ 40 off' },
Â Â Â Â Â Â { fillStyle:'#ffd1e8', text:'Subscribe and share channel' }
Â Â Â Â ];

Â Â Â Â // ===== å»ºç«‹è¼ªç›¤ï¼ˆåŠå¾‘å°‡ç”± layoutWheel è¦†è“‹ï¼‰=====
Â Â Â Â const wheel = new Winwheel({
Â Â Â Â Â Â canvasId:'wheelCanvas',
Â Â Â Â Â Â numSegments: segs.length,
Â Â Â Â Â Â outerRadius: 160,
Â Â Â Â Â Â textFontSize: 14,
Â Â Â Â Â Â textAlignment: 'center',
Â Â Â Â Â Â textFillStyle: '#333',
Â Â Â Â Â Â segments: segs,
Â Â Â Â Â Â animation:{
Â Â Â Â Â Â Â Â type:'spinToStop',
Â Â Â Â Â Â Â Â duration:5,
Â Â Â Â Â Â Â Â spins:8,
Â Â Â Â Â Â Â Â callbackFinished:onFinished,
Â Â Â Â Â Â Â Â callbackBefore: function(){ $btn.disabled = true; },
Â Â Â Â Â Â }
Â Â Â Â });
Â Â Â Â window.__pcdWheel = wheel;

Â Â Â Â // åˆæ¬¡å¸ƒå±€èˆ‡ç›£è½
Â Â Â Â layoutWheel();
Â Â Â Â updateChances();
Â Â Â Â if (window.Telegram && Telegram.WebApp && Telegram.WebApp.onEvent){
Â Â Â Â Â Â Telegram.WebApp.onEvent('viewportChanged', layoutWheel);
Â Â Â Â }
Â Â Â Â window.addEventListener('resize', layoutWheel);
Â Â Â Â new ResizeObserver(layoutWheel).observe(card);

Â Â Â Â // ===== æ—‹è½‰æµç¨‹ =====
Â Â Â Â let spinning = false;
Â Â Â Â $btn.addEventListener('click', () => {
Â Â Â Â Â Â if(spinning) return;
Â Â Â Â Â Â if(totalChances() <= 0){
Â Â Â Â Â Â Â Â const msg = 'æ¯äºº 3 å¤©å¯è½¬ 1 æ¬¡ï¼›æŠ½åˆ°ã€ŒOne more spin chance / Subscribe and share channelã€å¯åŠ  1 æ¬¡ã€‚\nOne spin every 3 days. Landing on bonus tiles grants +1 chance.';
Â Â Â Â Â Â Â Â if(isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg);
Â Â Â Â Â Â Â Â else alert(msg);
Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â }
Â Â Â Â Â Â spinning = true;
Â Â Â Â Â Â consumeChance();
Â Â Â Â Â Â updateChances();
Â Â Â Â Â Â $btn.textContent = 'ğŸ° æ—‹è½¬ä¸­ / Spinningâ€¦';
Â Â Â Â Â Â toast('ç¥ä½ å¥½è¿ï¼Good luck!');
Â Â Â Â Â Â wheel.startAnimation();
Â Â Â Â Â Â setTimeout(()=>{ spinning = false; }, 5200);
Â Â Â Â });

Â Â Â Â // ===== çµæœè™•ç†èˆ‡å›å‚³ =====
Â Â Â Â function onFinished(segment){
Â Â Â Â Â Â const result = segment?.text || '';
Â Â Â Â Â Â $btn.textContent = 'ğŸ¯ Start / å¼€å§‹';
Â Â Â Â Â Â $btn.disabled = totalChances() <= 0;

Â Â Â Â Â Â const isOneMore = /One more spin chance/i.test(result);
Â Â Â Â Â Â const isSubscribe = /Subscribe and share channel/i.test(result);

Â Â Â Â Â Â if(isOneMore){
Â Â Â Â Â Â Â Â addBonus(1);
Â Â Â Â Â Â Â Â updateChances();
Â Â Â Â Â Â Â Â notify('è·å¾— +1 æ¬¡æœºä¼š Â· +1 extra chance');
Â Â Â Â Â Â }else if(isSubscribe){
Â Â Â Â Â Â Â Â addBonus(1);
Â Â Â Â Â Â Â Â updateChances();
Â Â Â Â Â Â Â Â if(isTG) Telegram.WebApp.openTelegramLink("https://t.me/pcatdolls");
Â Â Â Â Â Â Â Â notify('è®¢é˜…æˆåŠŸ +1 æ¬¡æœºä¼š Â· +1 extra chance added');
Â Â Â Â Â Â }else if(/Sorry/i.test(result)){
Â Â Â Â Â Â Â Â notify('è°¢è°¢å‚ä¸ Â· Thanks for playing');
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â notify('æ­å–œä¸­å¥–ï¼š' + result + '\nCongratulations!');
Â Â Â Â Â Â }

Â Â Â Â Â Â const userObj = (isTG && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) || null;
Â Â Â Â Â Â const userName = userObj ? ((userObj.first_name || '') + (userObj.last_name ? (' ' + userObj.last_name) : '')) : 'Guest';
Â Â Â Â Â Â const userHandle = userObj && userObj.username ? ('@' + userObj.username) : '';
Â Â Â Â Â Â const payload = `Winner: ${userName}${userHandle ? ' ' + userHandle : ''} | Result: ${result}`;
Â Â Â Â Â Â if(isTG && Telegram.WebApp.sendData){
Â Â Â Â Â Â Â Â try { Telegram.WebApp.sendData(payload); } catch(e){}
Â Â Â Â Â Â }

Â Â Â Â Â Â try{
Â Â Â Â Â Â Â Â if(isTG && Telegram.WebApp.HapticFeedback){
Â Â Â Â Â Â Â Â Â Â Telegram.WebApp.HapticFeedback.notificationOccurred('success');
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }catch(e){}
Â Â Â Â }

Â Â Â Â function notify(message){
Â Â Â Â Â Â if(isTG && Telegram.WebApp.showPopup){
Â Â Â Â Â Â Â Â Telegram.WebApp.showPopup({ title:'PCD Lucky Wheel', message, buttons:[{type:'ok', id:'ok'}] });
Â Â Â Â Â Â }else if(isTG && Telegram.WebApp.showAlert){
Â Â Â Â Â Â Â Â Telegram.WebApp.showAlert(message);
Â Â Â Â Â Â }else{
Â Â Â Â Â Â Â Â alert(message);
Â Â Â Â Â Â }
Â Â Â Â Â Â toast(message.replace(/\n/g,' Â· '));
Â Â Â Â Â Â updateChances();
Â Â Â Â }
Â Â })();
Â Â </script>
</body>
</html>
