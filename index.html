<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCD Lucky Wheel</title>
<style>
  :root{
    --bg:#faf6ff; --card:#ffffff; --accent:#7b2cbf; --muted:#6b7280;
    --shadow:0 10px 20px rgba(31,27,65,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'PingFang SC','Noto Sans SC','Noto Sans','Helvetica Neue',Arial,sans-serif;color:#222}
  .card{max-width:720px;margin:28px auto;padding:20px 20px 28px;background:var(--card);border-radius:20px;box-shadow:var(--shadow)}
  .stage{display:flex;justify-content:center;margin-top:6px}
  #wheel{width:100%;max-width:560px;aspect-ratio:1;border-radius:24px;background:#f3ecff}
  .center-pointer{position:relative;margin-top:-52%;height:0;pointer-events:none}
  .center-pointer::after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);
    border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid var(--accent);
  }
  .actions{display:flex;justify-content:center;margin-top:18px}
  .btn{
    background:linear-gradient(180deg,#f2d6ff,#f8cddc);color:#5a189a;font-weight:800;
    font-size:24px;padding:16px 28px;border:none;border-radius:18px;box-shadow:var(--shadow);cursor:pointer
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chipRow{display:flex;gap:12px;justify-content:center;margin:12px 0}
  .chip{display:flex;align-items:center;gap:10px;border-radius:16px;padding:12px 16px;font-weight:700;background:#fff;box-shadow:var(--shadow);color:#3b3b3b}
  .chip .dot{font-size:20px}
  .muted{color:var(--muted);text-align:center;font-size:14px;line-height:1.6}
  #remaining{margin-top:6px;text-align:center;color:#8666ff;font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <div class="stage">
      <canvas id="wheel"></canvas>
    </div>
    <div class="center-pointer" aria-hidden="true"></div>

    <div class="actions">
      <button id="startBtn" class="btn">开始 / Start</button>
    </div>

    <div id="remaining"></div>

    <div class="chipRow">
      <button id="subBtn"   class="chip"><span class="dot">✅</span><span id="subText">订阅 PCD / Subscribe PCD</span></button>
      <button id="shareBtn" class="chip"><span class="dot">🔗</span><span id="shareText">分享 / Share</span></button>
    </div>

    <div id="rule" class="muted">
      🌟 每 <b>3 天</b> 1 次；完成 <b>订阅 + 分享</b> 再 +1 次。抽到 <b>🎁 one more chance</b> 再送 +1 次。<br/>
      Every <b>3 days</b> 1 spin; +1 after subscribing + sharing; +1 on “🎁 one more chance”.
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  const lang = (navigator.language || 'en').toLowerCase();
  const isZH = lang.startsWith('zh');
  const T = {
    start: isZH ? '开始 / Start' : 'Start',
    rule: isZH ? '🌟 每 3 天 1 次；完成 订阅 + 分享 再 +1 次。抽到 🎁 one more chance 再送 +1 次。' : '🌟 Every 3 days 1 spin; +1 after subscribing + sharing; +1 on “🎁 one more chance”.',
    sorry: isZH ? '😢 很遗憾' : '😢 sorry',
    oneMore: '🎁 one more chance',
    usedup: isZH ? '本期次数已用完（每 3 天重置）' : 'No spins left this period (resets every 3 days)',
    congrats: isZH ? '🎉 恭喜中奖！' : '🎉 Congratulations!'
  };

  document.getElementById('startBtn').textContent = T.start;
  document.getElementById('rule').innerHTML = T.rule;

  const TG = window.Telegram?.WebApp || null;
  if (TG) TG.ready?.();

  const LS_KEY = 'pcd_luckywheel_state_v3days';
  const epoch = new Date(2025,0,1).getTime();
  const bucket = Math.floor((Date.now() - epoch)/(3*24*3600*1000));
  let state = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  if (state.period !== bucket){
    state = {period:bucket,used:0,subscribed:false,shared:false,bonus:0};
    localStorage.setItem(LS_KEY,JSON.stringify(state));
  }

  function allowance(){return 1+(state.subscribed&&state.shared?1:0)+(state.bonus||0);}
  function remaining(){return Math.max(0,allowance()-(state.used||0));}
  const rem=document.getElementById('remaining');
  function update(){rem.textContent=isZH?`剩余次数：${remaining()} / ${allowance()}`:`Remaining: ${remaining()} / ${allowance()}`;start.disabled=remaining()<=0;}
  const start=document.getElementById('startBtn');const sub=document.getElementById('subBtn');const share=document.getElementById('shareBtn');
  sub.onclick=()=>{window.open('https://t.me/pcatdolls','_blank');state.subscribed=true;localStorage.setItem(LS_KEY,JSON.stringify(state));update();};
  share.onclick=()=>{window.open('https://t.me/share/url?url='+encodeURIComponent(location.href),'_blank');state.shared=true;localStorage.setItem(LS_KEY,JSON.stringify(state));update();};

  const wheel=document.getElementById('wheel');const ctx=wheel.getContext('2d');
  const DPR=2,size=600;wheel.width=size*DPR;wheel.height=size*DPR;
  const W=wheel.width,H=wheel.height,R=W/2*0.8,CX=W/2,CY=H/2;
  const prizes=[
    `1 ${T.sorry}`,
    "45⏰ or 60⏰ / 10 off",
    `3 ${T.sorry}`,
    "45⏰ or 60⏰ / 10 off",
    T.oneMore,
    "45⏰ or 60⏰ / 20 off",
    `8 ${T.sorry}`,
    "45⏰ or 60⏰ / 40 off",
    `5 ${T.sorry}`
  ];
  const segColors=["#e3f2fd","#ffd7d7","#e0f7fa","#ffd7d7","#fff3bf","#ffe9ec","#e8e0ff","#ffe9ec","#efe7ff"];
  const n=prizes.length,segA=2*Math.PI/n;let rot=0;
  function draw(){
    ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(CX,CY);ctx.rotate(rot-Math.PI/2);
    for(let i=0;i<n;i++){ctx.beginPath();ctx.moveTo(0,0);ctx.fillStyle=segColors[i];ctx.arc(0,0,R,i*segA,(i+1)*segA);ctx.fill();
      ctx.save();ctx.rotate(i*segA+segA/2);ctx.translate(R*0.72,0);ctx.rotate(Math.PI/2);ctx.fillStyle="#333";ctx.font=`${22*DPR}px Arial`;
      wrap(prizes[i],0,0,R*0.38,28*DPR);ctx.restore();}
    ctx.fillStyle="#a16de2";ctx.beginPath();ctx.arc(0,0,R*0.18,0,Math.PI*2);ctx.fill();
    ctx.fillStyle="#fff";ctx.beginPath();ctx.arc(0,0,R*0.10,0,Math.PI*2);ctx.fill();ctx.restore();}
  function wrap(t,x,y,m,l){const w=t.split(' ');let line='',yy=0;for(let i=0;i<w.length;i++){const test=line+w[i]+' ';if(ctx.measureText(test).width>m&&i>0){ctx.fillText(line,x,y+yy);line=w[i]+' ';yy+=l;}else line=test;}ctx.fillText(line,x,y+yy);}
  function spin(){if(remaining()<=0){alert(T.usedup);return;}start.disabled=true;const idx=Math.floor(Math.random()*n);const fR=-idx*segA+(Math.PI*2)*6;
    const s=performance.now(),D=4200;function anim(t){const p=Math.min(1,(t-s)/D),e=1-Math.pow(1-p,3);rot=rot+(fR-rot)*e;draw();if(p<1)requestAnimationFrame(anim);else end(idx);}requestAnimationFrame(anim);}
  function end(i){state.used++;const txt=prizes[i];if(/one\s*more\s*chance/i.test(txt)){state.bonus++;}localStorage.setItem(LS_KEY,JSON.stringify(state));update();alert(`${T.congrats}\n\n${txt}`);if(TG){TG.sendData(JSON.stringify({result:txt,used:state.used,bonus:state.bonus,remaining:remaining()}));}}
  draw();update();
  </script>
</body>
</html>
