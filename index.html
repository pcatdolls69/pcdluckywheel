<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCD Lucky Wheel</title>
<style>
  :root{
    --bg:#f6f0f8; --card:#fff; --text:#3b3b3b; --muted:#8a8a8a;
    --accent:#7a2c87; --accent2:#d6b3df; --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg);
    display:flex; align-items:center; justify-content:center; min-height:100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, PingFang SC, "Noto Sans CJK TC",
                 "Hiragino Sans GB", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    color:var(--text);
  }
  .card{
    width:min(960px,92vw); background:var(--card); border-radius:28px; padding:24px 18px;
    box-shadow:var(--shadow)
  }
  .stage{position:relative; background:#faf6fd; border-radius:24px; aspect-ratio:1/1; width:100%; max-width:720px; margin:0 auto; 
         border:1px solid #efe7f5; box-shadow: inset 0 0 0 8px #efe7f5}
  canvas{width:100%; height:100%; display:block; border-radius:16px}
  .center-pointer{
    position:absolute; inset:auto 0 50% 0; margin:auto; translate:0 50%;
    width:92px; height:92px; border-radius:50%;
    background:radial-gradient(circle at 50% 45%, #fff 0 28px, var(--accent) 28px 46px, #fff0 47px);
    box-shadow:var(--shadow)
  }
  .actions{display:flex; justify-content:center; margin:18px 0 10px}
  .btn{
    min-width:280px; height:64px; padding:0 28px; border:0; border-radius:20px; cursor:pointer;
    background:linear-gradient(135deg,#ff9fd2 0%,#f0b9ff 100%);
    color:#632d79; font-weight:800; font-size:22px; box-shadow:var(--shadow)
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  .chipRow{display:flex; gap:14px; justify-content:center; margin:8px 0 10px}
  .chip{
    display:flex; align-items:center; gap:10px; border-radius:16px; padding:12px 16px;
    background:#fff; box-shadow:var(--shadow); color:#3b3b3b; font-weight:600;
  }
  .chip .dot{font-size:20px}
  .muted{color:var(--muted); text-align:center; font-size:14px; line-height:1.6}
  .rule{margin-top:6px}
  .status{margin-top:8px}
  #remaining{ text-align:center; color:#8660c6; font-size:14px; margin-top:8px; }
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="card">
    <div class="stage">
      <canvas id="wheel"></canvas>
      <div class="center-pointer" aria-hidden="true"></div>
    </div>

    <div class="actions">
      <button id="startBtn" class="btn">開始 / Start</button>
    </div>

    <!-- 剩餘次數 -->
    <div id="remaining" aria-live="polite"></div>

    <div class="chipRow">
      <button id="subBtn" class="chip"><span class="dot">✅</span> 訂閱 PCD / Subscribe PCD</button>
      <button id="shareBtn" class="chip"><span class="dot">🔗</span> 分享 / Share</button>
    </div>

    <div class="muted rule">
      🌟 每人每周 1 次；完成 訂閱 + 分享 再 +1 次<br/>
      (Weekly 1 spin; +1 bonus after subscribing + sharing)
    </div>
    <div id="status" class="muted status"></div>
  </div>

<script>
/* ===== Telegram Mini App boot ===== */
const TG = window.Telegram?.WebApp;
if (TG) TG.expand();

/* ===== 配置：獎品 / 顏色 ===== */
const prizes = [
  "1 😢 sorry",
  "45💍 or 60💍 / 10 off",
  "3 😢 sorry",
  "45💍 or 60💍 / 20 off",
  "8 😢 sorry",
  "45💍 or 60💍 / 40 off",
  "5 😢 sorry",
  "45💍 or 60💍 / 10 off"
];
const segColors = ["#fcde","rgba(255,218,237,.9)","#cff","rgba(255,218,237,.9)","#ffe0","#ffd7","#e8e3ff","#ffd7"];
const n = prizes.length;

/* ===== 畫布尺寸 ===== */
const wheel = document.getElementById('wheel');
const ctx   = wheel.getContext('2d');
const DPR   = Math.max(2, window.devicePixelRatio || 1);
const size  = 640; 
wheel.width  = size * DPR;
wheel.height = size * DPR;
const W = wheel.width, H = wheel.height, R = Math.min(W, H)/2 * 0.82;
const CX = W/2, CY = H/2;
const segmentAngle = 2*Math.PI / n;
let currentRotation = 0; // radians

/* ===== 每週額度 & 狀態 ===== */
const STORE_KEY = "pcd_wheel_state";
const WEEK_KEY  = (() => {
  const now = new Date();
  const first = new Date(now.getFullYear(), 0, 1);
  const week = Math.floor((now - first)/(7*24*3600*1000));
  return `${now.getFullYear()}-${week}`;
})();
function loadState(){
  const raw = localStorage.getItem(STORE_KEY);
  let s = {};
  try{ s = JSON.parse(raw)||{} }catch(_){}
  if (s.week !== WEEK_KEY) s = {week:WEEK_KEY, used:0, subscribed:false, shared:false};
  return s;
}
function saveState(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }
let state = loadState();

/* 每週配額：1 次；若同時 subscribed+shared → +1 */
function getAllowance(){
  return 1 + (state.subscribed && state.shared ? 1 : 0);
}
function getRemaining(){ return Math.max(0, getAllowance() - (state.used||0)); }

function updateStatus(){
  const allow = getAllowance();
  const used  = state.used||0;
  const sub   = state.subscribed ? "✅" : "❌";
  const sh    = state.shared     ? "✅" : "❌";
  const el = document.getElementById('status');
  el.innerHTML =
    `本週可用：${allow} 次（已用 ${used}）・訂閱/分享：${sub}/${sh}`;
}
function updateRemainingDisplay(){
  const el = document.getElementById('remaining');
  if (!el) return;
  el.textContent = `剩餘次數：${getRemaining()}`
}

/* ===== 畫輪盤 ===== */
function drawWheel(){
  ctx.clearRect(0,0,W,H);
  ctx.save();
  ctx.translate(CX, CY);
  ctx.rotate(currentRotation);

  // 使 12 點鐘方向為 0 度（上方指針）
  ctx.rotate(-Math.PI/2);

  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.fillStyle = segColors[i % segColors.length];
    ctx.arc(0,0,R, i*segmentAngle, (i+1)*segmentAngle);
    ctx.closePath(); ctx.fill();

    // 文字
    ctx.save();
    ctx.rotate(i*segmentAngle + segmentAngle/2);
    ctx.textAlign = "center";
    ctx.fillStyle = "#2b2b2b";
    ctx.font = `${22*DPR}px Arial`;
    ctx.translate(R*0.68, 0);
    ctx.rotate(Math.PI/2);
    wrapText(prizes[i], -120, -10, 240, 28);
    ctx.restore();
  }
  ctx.restore();
}

// 多行斷字
function wrapText(txt, x, y, maxWidth, lineHeight){
  const words = (""+txt).split(" ");
  let line = "", yy = y;
  for(let i=0;i<words.length;i++){
    const test = line + (line? " ":"") + words[i];
    const w = ctx.measureText(test).width;
    if (w < maxWidth){
      line = test;
    }else{
      ctx.fillText(line, x, yy);
      line = words[i];
      yy += lineHeight;
    }
  }
  ctx.fillText(line, x, yy);
}

/* ===== 旋轉邏輯 ===== */
let spinning = false;
function spin(){
  if (spinning) return;
  if (getRemaining()<=0){ alert("本周已用完 / Weekly allowance used up"); return; }
  spinning = true;
  startBtn.disabled = true;

  const targetIndex = Math.floor(Math.random()*n);
  const targetAngle = -Math.PI/2 - (targetIndex*segmentAngle + segmentAngle/2);
  const extra = (Math.PI*2) * 6;         // 多轉幾圈
  const finalRot = normalize(currentRotation) + extra + shortestDelta(currentRotation, targetAngle);
  const start = performance.now();
  const D = 4200;                         // 動畫毫秒

  (function animate(t0){
    const p = Math.min(1,(t0-start)/D);
    const ease = 1 - Math.pow(1-p,3);
    const rot = currentRotation + (finalRot-currentRotation)*ease;
    currentRotation = rot;
    drawWheel();

    if(p<1){ requestAnimationFrame(animate); }
    else{
      currentRotation = normalize(finalRot);
      drawWheel();

      const idx = getIndexByRotation(currentRotation);
      finish(prizes[idx], idx);
    }
  })(start);
}

function shortestDelta(from, to){
  let d = to - (from % (2*Math.PI));
  if(d >  Math.PI) d -= 2*Math.PI;
  if(d < -Math.PI) d += 2*Math.PI;
  return d;
}
function normalize(a){
  a = a % (2*Math.PI);
  if (a<0) a += 2*Math.PI;
  return a;
}
function getIndexByRotation(rot){
  const a = normalize(rot);
  const topAngle = 0; // 指針在 12 點鐘方向
  // 轉成以 12 點鐘為 0 的角度
  const angFromTop = normalize(topAngle - a);
  const index = Math.floor( angFromTop / segmentAngle );
  return (index + n) % n;
}

/* ===== 完成一抽 ===== */
function finish(text, index){
  state.used = (state.used||0) + 1;
  saveState(state);
  updateStatus();
  updateRemainingDisplay();

  alert("🎉 恭喜中獎！/ 🎉 Congratulations!\n\n" + prizes[index]);

  // 回傳給 Telegram bot
  if (TG){
    const payload = {
      type: "spin_result",
      result: prizes[index],
      index,
      used: state.used,
      allowance: getAllowance(),
      subscribed: state.subscribed,
      shared: state.shared
    };
    try{ TG.sendData(JSON.stringify(payload)); }catch(_){}
  }

  startBtn.disabled = getRemaining()<=0;
  spinning = false;
}

/* ===== UI 綁定 ===== */
const startBtn = document.getElementById('startBtn');
const subBtn   = document.getElementById('subBtn');
const shareBtn = document.getElementById('shareBtn');

startBtn.addEventListener('click', spin);

subBtn.addEventListener('click', () => {
  // 你的頻道
  window.open('https://t.me/pcatdolls', '_blank');
  state.subscribed = true; saveState(state); updateStatus(); updateRemainingDisplay();
  startBtn.disabled = getRemaining()<=0;
});

shareBtn.addEventListener('click', async () => {
  const shareData = {
    title: 'PCD Lucky Wheel',
    text:  '來抽獎！Try your luck!',
    url:   location.href
  };
  try{
    if(navigator.share){ await navigator.share(shareData); }
    else{
      window.open('https://t.me/share/url?url='+
        encodeURIComponent(location.href)+'&text='+encodeURIComponent('🎡PCD抽獎轉盤'), '_blank');
    }
    state.shared = true; saveState(state); updateStatus(); updateRemainingDisplay();
    startBtn.disabled = getRemaining()<=0;
  }catch(e){ /* user cancelled */ }
});

/* ===== 初始化 ===== */
drawWheel();
updateStatus();
updateRemainingDisplay();
startBtn.disabled = getRemaining()<=0;
window.addEventListener('resize', () => {
  // demo 簡化：保持固定尺寸，忽略 resize 重算
});
</script>
</body>
</html>
