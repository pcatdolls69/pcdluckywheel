<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>幸运转盘 / Lucky Wheel</title>
<style>
  body{
    margin:0; color:#333;
    font-family:'Noto Sans SC', Arial, sans-serif;
    background: linear-gradient(180deg, #fde6ff 0%, #e4f2ff 100%);
    display:flex; flex-direction:column; align-items:center; min-height:100vh;
  }
  h2{margin:20px 0 10px}
  #wheel-container{position:relative; width:420px; height:420px; margin-top:10px}
  canvas{
    width:100%; height:100%; border-radius:50%;
    box-shadow: 0 0 30px rgba(255,255,255,.85), 0 0 60px rgba(255,200,255,.6);
    background:#fff;
  }
  #centerPointer{position:absolute; inset:0; pointer-events:none}
  #centerPointer polygon{fill:#4b0082}

  /* 主按钮：粉紫渐变，圆角 */
  #spinBtn{
    margin-top:20px; padding:14px 32px; font-size:18px; color:#fff; border:0; border-radius:16px;
    background: linear-gradient(90deg, #e8b3ff, #bcd2ff);
    box-shadow: 0 4px 10px rgba(0,0,0,.15); cursor:pointer;
  }
  #spinBtn:active{transform:scale(.98)}
  #status{margin-top:10px; font-size:14px}

  /* 订阅 / 分享 区块 */
  .cta{
    display:flex; gap:12px; margin-top:14px;
  }
  .cta button{
    padding:10px 16px; border-radius:12px; border:2px solid #d0b3ff; background:#fff; color:#4b0c7a;
    font-weight:700; cursor:pointer;
  }
  .cta button:active{transform:scale(.98)}

  /* 底部注意 */
  #footer{margin:18px 0 24px; text-align:center; font-size:13px}
  #footer a{color:#6a00cc; font-weight:700; text-decoration:none}
</style>
</head>
<body>

<h2>幸运转盘 / Lucky Wheel</h2>

<div id="wheel-container">
  <canvas id="wheel" width="420" height="420"></canvas>
  <!-- 中心深紫三角指针（从中心指向 12 点，尖端略超出圆盘） -->
  <svg id="centerPointer" viewBox="0 0 420 420" aria-hidden="true">
    <polygon points="195,210 225,210 210,16"></polygon>
  </svg>
</div>

<button id="spinBtn">开始抽奖 / Start</button>
<div id="status">剩余次数 / Chances: <span id="chances">3</span></div>

<div class="cta">
  <button id="subBtn">🔗 订阅 / Subscribe（+1）</button>
  <button id="shareBtn">🔗 分享 / Share（+1）</button>
</div>

<div id="footer">
  ⚠️ 所有奖项不能重叠使用 / All prizes cannot be combined<br>
  <a href="https://t.me/pcatdolls" target="_blank">pcatdolls 频道 / Channel</a>
</div>

<script>
/* ===== Telegram Mini App 初始化 ===== */
const isTG = !!(window.Telegram && Telegram.WebApp);
if (isTG) Telegram.WebApp.ready();

/* ===== 轮盘数据 ===== */
const prizes = [
  "45⏰ or 60⏰ / 10 OFF",
  "45⏰ or 60⏰ / 20 OFF",
  "One more spin chance",
  "45⏰ or 60⏰ / 10 OFF",
  "Sorry 😢",
  "45⏰ or 60⏰ / 20 OFF",
  "Sorry 😢",
  "45⏰ or 60⏰ / 40 OFF",
  "Sorry 😢"
];
const colors = ["#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8","#cbb2fe","#b6e1ff","#ffe07a","#ffd1e8"];

let chances = 3; // 初始次数（可按需改）
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');

function drawWheel(angleOffset = 0) {
  const cx = 210, cy = 210, r = 200;
  const n = prizes.length;
  const arc = 2*Math.PI / n;
  ctx.clearRect(0,0,420,420);
  for (let i=0;i<n;i++){
    const start = i*arc + angleOffset;
    const end = start + arc;

    // 扇形
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,end);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();

    // 文案（黑色）
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + arc/2);
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#000";                          // ✅ 黑色
    ctx.font = "bold 16px Arial, 'Noto Sans SC', sans-serif";
    ctx.fillText(prizes[i], r-20, 0);
    ctx.restore();
  }
}
drawWheel();

/* ===== 抽奖 ===== */
const spinBtn = document.getElementById('spinBtn');
const chancesEl = document.getElementById('chances');

function updateChances() {
  chancesEl.textContent = chances;
  spinBtn.disabled = chances <= 0;
}
updateChances();

spinBtn.addEventListener('click', () => {
  if (chances <= 0) {
    const msg = "每人一次 / No more chances.\n订阅或分享可获得 +1 / Subscribe or Share to get +1.";
    if (isTG && Telegram.WebApp.showAlert) Telegram.WebApp.showAlert(msg); else alert(msg);
    return;
  }
  chances--; updateChances();

  const spinAngle = 360*5 + Math.random()*360; // 五圈以上
  const duration = 4200;
  const start = performance.now();

  function step(now){
    const p = Math.min((now-start)/duration, 1);
    const ease = 1 - Math.pow(1-p,3); // 缓出
    drawWheel(ease * spinAngle * Math.PI/180);
    if (p < 1) requestAnimationFrame(step);
    else onDone(spinAngle);
  }
  requestAnimationFrame(step);
});

function onDone(spinAngleDeg){
  // 计算中奖项（与 12 点方向对齐）
  const n = prizes.length;
  const raw = (spinAngleDeg % 360) / 360;           // 0..1
  const idx = (n - 1 - Math.floor(raw * n)) % n;    // 指针在上方，角度越大索引越小
  const result = prizes[idx];

  // 弹窗（中英）
  const msg = /Sorry/.test(result)
    ? "谢谢参与 / Thanks for playing"
    : "恭喜中奖 / Congratulations!\n" + result;
  if (isTG && Telegram.WebApp.showPopup) {
    Telegram.WebApp.showPopup({title:"幸运转盘 / Lucky Wheel", message:msg, buttons:[{type:'ok', id:'ok'}]});
  } else if (isTG && Telegram.WebApp.showAlert) {
    Telegram.WebApp.showAlert(msg);
  } else {
    alert(msg);
  }

  // “One more spin chance” +1
  if (/One more spin chance/i.test(result)) { chances++; updateChances(); }

  // 回传给你的 bot（Mini App）
  if (isTG && Telegram.WebApp.sendData) {
    try {
      // 如果可取得用户名，把名字一起回传
      const u = Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user;
      const name = u ? ((u.first_name||'') + (u.last_name?(' '+u.last_name):'')) : 'Guest';
      const handle = u && u.username ? ('@'+u.username) : '';
      Telegram.WebApp.sendData(`Winner: ${name}${handle?' '+handle:''} | Result: ${result}`);
    } catch(e){}
  }

  // （可选）直接发到 @pcd_luckywheel_bot 频道/群 —— 用你的 Token 替换
  fetch("https://api.telegram.org/bot7779859704:AAHwAPPUhTQQRwVJ1FeGJUuY6BJ5vBmFths/sendMessage", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: "@pcd_luckywheel_bot",
      text: `🎯 抽奖结果 / Result: ${result}`
    })
  }).catch(()=>{});
}

/* ===== 订阅 & 分享：各 +1 ===== */
document.getElementById('subBtn').addEventListener('click', () => {
  if (isTG) Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
  chances++; updateChances();
});

document.getElementById('shareBtn').addEventListener('click', () => {
  try{
    if (isTG && Telegram.WebApp.shareToStory) {
      Telegram.WebApp.shareToStory({text:'PCD Lucky Wheel', widget_link:'https://t.me/pcatdolls'});
    } else if (isTG) {
      Telegram.WebApp.openTelegramLink('https://t.me/pcatdolls');
    } else {
      window.open('https://t.me/pcatdolls','_blank');
    }
  } finally {
    chances++; updateChances();
  }
});
</script>
</body>
</html>
