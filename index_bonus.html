<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>pcdluckywheel ‚Äî bonus</title>
  <style>
    :root{ --ring:#E8DFF6; --needle:#5B2D5B; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;min-height:100%;
      background:radial-gradient(1200px 600px at 50% -100px, #FFEFFE 0,#FFF 45%);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#222;
    }
    .card{
      width:min(92vw,560px);
      background:#fff;border-radius:24px;padding:18px 14px 24px;
      box-shadow:0 15px 30px rgba(0,0,0,.08);
      position:relative;
    }
    .needle{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      width:0;height:0;z-index:3;
      border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:26px solid var(--needle);
      filter: drop-shadow(0 4px 4px rgba(0,0,0,.12));
      pointer-events:none;
    }
    .wheel-wrap{position:relative;margin:24px auto 14px;display:flex;justify-content:center;}
    canvas{
      background:#fff;border-radius:50%;
      border:6px solid var(--ring);
      box-shadow: inset 0 0 0 4px #fff, 0 8px 20px rgba(0,0,0,.06);
      transition: transform 5s cubic-bezier(.17,.67,.83,.67);
      max-width:100%;height:auto;touch-action:manipulation;
    }
    .center-circle{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:68px;height:68px;border-radius:50%;border:8px solid var(--needle);background:#fff;z-index:2;pointer-events:none;
      box-shadow:0 4px 10px rgba(0,0,0,.10);
    }
    .btn{
      display:block;width:min(78%,360px);margin:6px auto 0;
      padding:14px 18px;font-size:18px;font-weight:800;border-radius:24px;border:none;cursor:pointer;
      background:linear-gradient(180deg,#EAC6FF,#FFBED6);color:#5E2B66;
      box-shadow:0 8px 18px rgba(171,107,198,.25);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .mini{
      padding:10px 12px;border-radius:14px;border:none;cursor:pointer;font-weight:800;
      color:#5E2B66;background:#F2E6FF;box-shadow:0 4px 10px rgba(171,107,198,.15);
    }
    .pill{font-size:12px;margin-top:8px;text-align:center;color:#666;white-space:pre-line}
  </style>
</head>
<body>
  <div class="card">
    <div class="needle"></div>
    <div class="wheel-wrap">
      <canvas id="wheelCanvas" width="420" height="420"></canvas>
      <div class="center-circle"></div>
    </div>
    <button id="spinBtn" class="btn">Start / ÈñãÂßã</button>
    <div class="row">
      <button id="subBtn"   class="mini">‚úÖ Subscribe / Ë®ÇÈñ± PCD</button>
      <button id="shareBtn" class="mini">üîó Share / ÂàÜ‰∫´</button>
    </div>
    <div id="status" class="pill"></div>
  </div>

<script>
// ===== Telegram WebApp init =====
if (window.Telegram && Telegram.WebApp) { Telegram.WebApp.expand(); Telegram.WebApp.ready(); }

const CHANNEL_URL = "https://t.me/pcatdolls";  // ‰Ω†ÁöÑÈ†ªÈÅìÈÄ£Áµê

// ===== Prize slices =====
const prizes = [
  { text: '1 üò¢ sorry',                 color: '#C9D5FF' },
  { text: '‚è∞ 45 or 60 / 10 off',        color: '#FFB6C1' },
  { text: '3 üò¢ sorry',                 color: '#A0D8EF' },
  { text: '‚è∞ 45 or 60 / 40 off',        color: '#FFF1A8' },
  { text: '5 üò¢ sorry',                 color: '#C9D5FF' },
  { text: '‚è∞ 45 or 60 / 10 off',        color: '#FFB6C1' },
  { text: '‚è∞ 45 or 60 / 20 off',        color: '#FF9DA8' },
  { text: '8 üò¢ sorry',                 color: '#A0E0AF' }
];
const n = prizes.length, anglePer = 360/n;

// ===== Canvas drawing =====
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const r = canvas.width/2 - 8;
const cx = canvas.width/2, cy = canvas.height/2;

function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let start = -Math.PI/2;
  for(let i=0;i<n;i++){
    const end = start + 2*Math.PI/n;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
    ctx.fillStyle = prizes[i].color; ctx.fill();
    ctx.save(); ctx.translate(cx,cy); const mid=(start+end)/2; ctx.rotate(mid);
    ctx.textAlign='center'; ctx.fillStyle='#333'; ctx.font='bold 16px Arial';
    ctx.fillText(prizes[i].text, r*0.62, 6);
    ctx.restore();
    start = end;
  }
  ctx.beginPath(); ctx.arc(cx,cy,r+2,0,Math.PI*2); ctx.strokeStyle='#E8DFF6'; ctx.lineWidth=6; ctx.stroke();
}
drawWheel();

// ===== Weekly limit + bonus (localStorage) =====
const K = 'pcdlw_';
function resetIfNeeded(){
  const lastReset = +(localStorage.getItem(K+'lastReset')||0);
  const now = Date.now();
  if (!lastReset || now - lastReset > 7*24*3600*1000){
    localStorage.setItem(K+'lastReset', String(now));
    localStorage.setItem(K+'spinsUsed', '0');
    localStorage.setItem(K+'bonusUnlocked', '0'); // 0/1
  }
}
resetIfNeeded();

function allowedSpins(){
  const bonus = localStorage.getItem(K+'bonusUnlocked') === '1';
  return 1 + (bonus ? 1 : 0);
}
function spinsUsed(){ return +(localStorage.getItem(K+'spinsUsed')||'0'); }
function addSpin(){ localStorage.setItem(K+'spinsUsed', String(spinsUsed()+1)); }
function statusText(){
  const left = Math.max(allowedSpins()-spinsUsed(), 0);
  const bonus = localStorage.getItem(K+'bonusUnlocked') === '1';
  return `Êú¨ÈÄ±ÂèØÁî®Ôºö${allowedSpins()} Ê¨°ÔºàÂê´Âä†Á¢º ${bonus?'+1':'0'}Ôºâ ¬∑ Ââ©È§ò left: ${left}
Weekly allowance: ${allowedSpins()} (bonus ${bonus?'+1':'0'}) ¬∑ remaining: ${left}`;
}
const statusEl = document.getElementById('status'); statusEl.textContent = statusText();

function normalize(a){ a%=360; if(a<0) a+=360; return a; }

const spinBtn = document.getElementById('spinBtn');
spinBtn.addEventListener('click', ()=>{
  resetIfNeeded();
  if (spinsUsed() >= allowedSpins()){
    alert('Â∑≤ÈÅîÊú¨ÈÄ±‰∏äÈôê„ÄÇË®ÇÈñ±ÊàñÂàÜ‰∫´ÂèØËß£Èéñ‰∏ÄÊ¨°Âä†Á¢ºÊäΩÔºÅ\nWeekly limit reached. Subscribe OR Share to unlock 1 bonus spin.');
    return;
  }
  const target = Math.floor(Math.random()*n);
  const turns = 8, offset = Math.random()*anglePer*0.6;
  const finalDeg = turns*360 + target*anglePer + offset;

  canvas.style.transform='rotate(0deg)'; void canvas.offsetWidth;
  canvas.style.transform=`rotate(${finalDeg}deg)`;
  spinBtn.disabled=true; spinBtn.textContent='Spinning... / ÊóãËΩâ‰∏≠...';

  setTimeout(()=>{
    const landed = normalize(finalDeg);
    let idx = Math.floor( normalize(360 - landed) / anglePer );
    if(idx>=n) idx=n-1;
    const result = prizes[idx].text;

    alert(`üéâ ÊÅ≠Âñú‰∏≠ÁçéÔºÅ / üéâ Congratulations!\n${result}`);
    spinBtn.textContent='Done / ÂÆåÊàê';
    addSpin(); statusEl.textContent = statusText();

    if (window.Telegram && Telegram.WebApp){
      const payload={ result, zh:`ÊÅ≠Âñú‰∏≠ÁçéÔºö${result}`, en:`Congratulations! You got ${result}`, at:new Date().toISOString(), bonusUnlocked:(localStorage.getItem(K+'bonusUnlocked')==='1') };
      try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}
    }
  }, 5100);
});

// ===== Subscribe & Share to unlock ONE extra spin =====
document.getElementById('subBtn').addEventListener('click', ()=>{
  // Âú® Telegram ÂÖßÈñãÈ†ªÈÅìÈÄ£Áµê
  const url = CHANNEL_URL;
  if (window.Telegram && Telegram.WebApp){
    Telegram.WebApp.openTelegramLink(url);
  } else {
    window.open(url, '_blank');
  }
  localStorage.setItem(K+'bonusUnlocked', '1');
  alert('ÊÑüË¨ùË®ÇÈñ±ÔºÅÂ∑≤Ëß£Èéñ‰∏ÄÊ¨°È°çÂ§ñÊäΩÁçéÊ©üÊúÉ üéÅ / Bonus spin unlocked!');
  statusEl.textContent = statusText();
});

document.getElementById('shareBtn').addEventListener('click', ()=>{
  const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(window.location.href) + '&text=' + encodeURIComponent('‰æÜÁé© PCD Lucky WheelÔºÅ');
  if (window.Telegram && Telegram.WebApp){
    Telegram.WebApp.openTelegramLink(shareUrl);
  } else if (navigator.share){
    navigator.share({ title:'PCD Lucky Wheel', text:'Try your luck!', url: window.location.href }).catch(()=>{});
  } else {
    window.open(shareUrl, '_blank');
  }
  localStorage.setItem(K+'bonusUnlocked', '1');
  alert('ÊÑüË¨ùÂàÜ‰∫´ÔºÅÂ∑≤Ëß£Èéñ‰∏ÄÊ¨°È°çÂ§ñÊäΩÁçéÊ©üÊúÉ üéÅ / Bonus spin unlocked!');
  statusEl.textContent = statusText();
});
</script>
</body>
</html>
