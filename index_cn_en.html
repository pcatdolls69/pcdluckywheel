<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>pcdluckywheel — bonus CN/EN</title>
  <style>
    :root{ --ring:#E8DFF6; --needle:#5B2D5B; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;min-height:100%;
      background:radial-gradient(1200px 600px at 50% -100px, #FFEFFE 0,#FFF 45%);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans SC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:#222;
    }
    .card{
      width:min(92vw,560px);
      background:#fff;border-radius:24px;padding:18px 14px 24px;
      box-shadow:0 15px 30px rgba(0,0,0,.08);
      position:relative;
    }
    .needle{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      width:0;height:0;z-index:3;
      border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:26px solid var(--needle);
      filter: drop-shadow(0 4px 4px rgba(0,0,0,.12));
      pointer-events:none;
    }
    .wheel-wrap{position:relative;margin:24px auto 14px;display:flex;justify-content:center;}
    canvas{
      background:#fff;border-radius:50%;
      border:6px solid var(--ring);
      box-shadow: inset 0 0 0 4px #fff, 0 8px 20px rgba(0,0,0,.06);
      transition: transform 5s cubic-bezier(.17,.67,.83,.67);
      max-width:100%;height:auto;touch-action:manipulation;
    }
    .center-circle{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:68px;height:68px;border-radius:50%;border:8px solid var(--needle);background:#fff;z-index:2;pointer-events:none;
      box-shadow:0 4px 10px rgba(0,0,0,.10);
    }
    .btn{
      display:block;width:min(78%,360px);margin:6px auto 0;
      padding:14px 18px;font-size:18px;font-weight:800;border-radius:24px;border:none;cursor:pointer;
      background:linear-gradient(180deg,#EAC6FF,#FFBED6);color:#5E2B66;
      box-shadow:0 8px 18px rgba(171,107,198,.25);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .mini{
      padding:10px 12px;border-radius:14px;border:none;cursor:pointer;font-weight:800;
      color:#5E2B66;background:#F2E6FF;box-shadow:0 4px 10px rgba(171,107,198,.15);
    }
    .pill{font-size:12px;margin-top:8px;text-align:center;color:#666;white-space:pre-line}
    .hint{font-size:12px;margin-top:6px;text-align:center;color:#8a589b;white-space:pre-line}
    .footnote{font-size:12px;margin-top:10px;text-align:center;color:#555;white-space:pre-line}
  </style>
</head>
<body>
  <div class="card">
    <div class="needle"></div>
    <div class="wheel-wrap">
      <canvas id="wheelCanvas" width="420" height="420"></canvas>
      <div class="center-circle"></div>
    </div>
    <button id="spinBtn" class="btn">开始 / Start</button>
    <div class="row">
      <button id="subBtn"   class="mini">✅ 订阅 PCD / Subscribe PCD</button>
      <button id="shareBtn" class="mini">🔗 分享 / Share</button>
    </div>
    <div id="status" class="pill"></div>
    <div id="hint"   class="hint"></div>
    <div class="footnote">🌟 每人每周仅可转一次，完成「订阅 + 分享」可额外再转一次\n🌟 Each user can spin once per week. Complete BOTH "Subscribe + Share" to unlock one extra spin.</div>
  </div>

<script>
// ===== Telegram WebApp init =====
if (window.Telegram && Telegram.WebApp) { Telegram.WebApp.expand(); Telegram.WebApp.ready(); }

const CHANNEL_URL = "https://t.me/pcatdolls";  // 你的频道链接
const REQUIRE_BOTH = true; // true: 订阅+分享都完成才 +1；false: 任一完成就 +1

// ===== Prize slices =====
const prizes = [
  { text: '1 😢 sorry',                 color: '#C9D5FF' },
  { text: '⏰ 45 or 60 / 10 off',        color: '#FFB6C1' },
  { text: '3 😢 sorry',                 color: '#A0D8EF' },
  { text: '⏰ 45 or 60 / 40 off',        color: '#FFF1A8' },
  { text: '5 😢 sorry',                 color: '#C9D5FF' },
  { text: '⏰ 45 or 60 / 10 off',        color: '#FFB6C1' },
  { text: '⏰ 45 or 60 / 20 off',        color: '#FF9DA8' },
  { text: '8 😢 sorry',                 color: '#A0E0AF' }
];
const n = prizes.length, anglePer = 360/n;

// ===== Canvas drawing =====
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
const r = canvas.width/2 - 8;
const cx = canvas.width/2, cy = canvas.height/2;

function drawWheel(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let start = -Math.PI/2;
  for(let i=0;i<n;i++){
    const end = start + 2*Math.PI/n;
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
    ctx.fillStyle = prizes[i].color; ctx.fill();
    ctx.save(); ctx.translate(cx,cy); const mid=(start+end)/2; ctx.rotate(mid);
    ctx.textAlign='center'; ctx.fillStyle='#333'; ctx.font='bold 16px Arial';
    ctx.fillText(prizes[i].text, r*0.62, 6);
    ctx.restore();
    start = end;
  }
  ctx.beginPath(); ctx.arc(cx,cy,r+2,0,Math.PI*2); ctx.strokeStyle='#E8DFF6'; ctx.lineWidth=6; ctx.stroke();
}
drawWheel();

// ===== Weekly limit + bonus (localStorage) =====
const K = 'pcdlw_';
function resetIfNeeded(){
  const lastReset = +(localStorage.getItem(K+'lastReset')||0);
  const now = Date.now();
  if (!lastReset || now - lastReset > 7*24*3600*1000){
    localStorage.setItem(K+'lastReset', String(now));
    localStorage.setItem(K+'spinsUsed', '0');
    localStorage.setItem(K+'subscribed', '0');
    localStorage.setItem(K+'shared', '0');
  }
}
resetIfNeeded();

function bonusUnlocked(){
  const sub = localStorage.getItem(K+'subscribed') === '1';
  const sha = localStorage.getItem(K+'shared') === '1';
  return REQUIRE_BOTH ? (sub && sha) : (sub || sha);
}

function allowedSpins(){ return 1 + (bonusUnlocked() ? 1 : 0); }
function spinsUsed(){ return +(localStorage.getItem(K+'spinsUsed')||'0'); }
function addSpin(){ localStorage.setItem(K+'spinsUsed', String(spinsUsed()+1)); }

function statusText(){
  const sub = localStorage.getItem(K+'subscribed') === '1';
  const sha = localStorage.getItem(K+'shared') === '1';
  const left = Math.max(allowedSpins()-spinsUsed(), 0);
  const ruleZh = REQUIRE_BOTH ? '需同时完成「订阅 + 分享」才 +1' : '完成「订阅或分享」其一即可 +1';
  const ruleEn = REQUIRE_BOTH ? 'Bonus +1 requires BOTH subscribe & share' : 'Bonus +1 if EITHER subscribe OR share';
  return `已用/Used: ${spinsUsed()} / ${allowedSpins()} · 订阅:${sub?'✅':'❌'} 分享:${sha?'✅':'❌'} · 剩余/Left: ${left}\n${ruleZh}\n${ruleEn}`;
}
function hintText(){
  return '📢 订阅频道 / Subscribe channel：@pcatdolls\n🔗 分享 / Share：把本页链接分享给朋友';
}
const statusEl = document.getElementById('status'); statusEl.textContent = statusText();
const hintEl   = document.getElementById('hint');   hintEl.textContent   = hintText();

function normalize(a){ a%=360; if(a<0) a+=360; return a; }

const spinBtn = document.getElementById('spinBtn');
spinBtn.addEventListener('click', ()=>{
  resetIfNeeded();
  if (spinsUsed() >= allowedSpins()){
    const msgZh = REQUIRE_BOTH ? '本周次数已用完。完成 订阅+分享 可解锁一次加码抽！' : '本周次数已用完。订阅或分享可解锁一次加码抽！';
    const msgEn = REQUIRE_BOTH ? 'Weekly limit reached. Subscribe AND Share to unlock 1 bonus spin.' : 'Weekly limit reached. Subscribe OR Share to unlock 1 bonus spin.';
    alert(`${msgZh}\n${msgEn}`);
    return;
  }
  const target = Math.floor(Math.random()*n);
  const turns = 8, offset = Math.random()*anglePer*0.6;
  const finalDeg = turns*360 + target*anglePer + offset;

  canvas.style.transform='rotate(0deg)'; void canvas.offsetWidth;
  canvas.style.transform=`rotate(${finalDeg}deg)`;
  spinBtn.disabled=true; spinBtn.textContent='旋转中... / Spinning...';

  setTimeout(()=>{
    const landed = normalize(finalDeg);
    let idx = Math.floor( normalize(360 - landed) / anglePer );
    if(idx>=n) idx=n-1;
    const result = prizes[idx].text;

    alert(`🎉 恭喜中奖！ / 🎉 Congratulations!\n${result}`);
    spinBtn.textContent='完成 / Done';
    addSpin(); statusEl.textContent = statusText();

    if (window.Telegram && Telegram.WebApp){
      const payload={ result, zh:`恭喜中奖：${result}`, en:`Congratulations! You got ${result}`, at:new Date().toISOString(), subscribed:(localStorage.getItem(K+'subscribed')==='1'), shared:(localStorage.getItem(K+'shared')==='1') };
      try{ Telegram.WebApp.sendData(JSON.stringify(payload)); }catch(e){}
    }
  }, 5100);
});

// ===== Subscribe & Share tracking =====
document.getElementById('subBtn').addEventListener('click', ()=>{
  const url = CHANNEL_URL;
  if (window.Telegram && Telegram.WebApp){ Telegram.WebApp.openTelegramLink(url); }
  else { window.open(url, '_blank'); }
  localStorage.setItem(K+'subscribed', '1');
  alert('感谢订阅！/ Thanks for subscribing!');
  statusEl.textContent = statusText();
});
document.getElementById('shareBtn').addEventListener('click', ()=>{
  const url = 'https://t.me/share/url?url=' + encodeURIComponent(window.location.href) + '&text=' + encodeURIComponent('来玩 PCD Lucky Wheel！/ Play PCD Lucky Wheel!');
  if (window.Telegram && Telegram.WebApp){ Telegram.WebApp.openTelegramLink(url); }
  else if (navigator.share){ navigator.share({ title:'PCD Lucky Wheel', text:'Play PCD Lucky Wheel!', url: window.location.href }).catch(()=>{}); }
  else { window.open(url, '_blank'); }
  localStorage.setItem(K+'shared', '1');
  alert('感谢分享！/ Thanks for sharing!');
  statusEl.textContent = statusText();
});
</script>
</body>
</html>
